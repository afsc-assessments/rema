<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>REMA model validation • rema</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="REMA model validation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rema</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/ex1_basics.html">REMA basics</a></li>
    <li><a class="dropdown-item" href="../articles/ex2_cpue.html">Fitting to an additional CPUE survey</a></li>
    <li><a class="dropdown-item" href="../articles/ex3_zeros.html">Strategies for handling zero biomass observations</a></li>
    <li><a class="dropdown-item" href="../articles/ex4_model_validation.html">REMA model validation</a></li>
    <li><a class="dropdown-item" href="../articles/rema_equations.html">REMA model equations</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/JaneSullivan-NOAA/rema/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>REMA model validation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/JaneSullivan-NOAA/rema/blob/main/vignettes/ex4_model_validation.Rmd" class="external-link"><code>vignettes/ex4_model_validation.Rmd</code></a></small>
      <div class="d-none name"><code>ex4_model_validation.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h3>
<ul>
<li><p>Fisheries stock assessments are moving towards state-space
estimation, which boasts a range of benefits, including separation and
estimation of observation and process error, a more elegant framework
for handling missing data, a high degree of flexibility with respect to
model architecture and inclusion of different data types, and the
potential for improved projections and predictive skill (needs
citations).</p></li>
<li><p>The flexibility and relative ease of fitting state-space models
means they can increase in complexity and dimensionality rapidly. While
easy to fit, state-space models are often challenging to validate and
even simple models can suffer from estimation issues (Auger‐Méthé et
al., 2016).</p></li>
<li><p>At the North Pacific Fishery Management Council, the “random
effects model” (REMA) used for Tier 5 groundfish stock assessments, Tier
4 crab stock assessments, and apportionment for many stocks, is by far
the most common state-space model used for fishery management. Despite
the high impact of this model, we have no standard model validation
practices for REMA.</p></li>
<li><p>The goals of this study are to provide several examples of common
state-space model validation techniques applied to real life REMA models
and to make preliminary recommendations for model validation of REMA and
other state-space models within our management framework.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="a-testing-framework-for-rema-model-validation">A testing framework for REMA model validation<a class="anchor" aria-label="anchor" href="#a-testing-framework-for-rema-model-validation"></a>
</h3>
<p>In this vignette, we will be testing that (1) REMA is working as
expected (i.e., code has been implemented correctly and parameters are
estimated without bias), and (2) that the assumptions made when
parameterizing and estimating REMA are valid, including assumptions
related to random effects and error structure. We use two example stocks
with varying levels of complexity:</p>
<ul>
<li><p>Aleutian Islands Pacific cod (AI Pcod; Spies et al., 2023): a
simple, univariate case, which fits to a single time series of the AI
bottom trawl survey and estimates one process error</p></li>
<li><p>Gulf of Alaska Thornyhead rockfish (GOA thornyhead; Echave et
al., 2022): a complex, multi-strata and multi-survey case, which
estimates multiple process errors, a scaling parameter for the longline
survey, and two additional observation errors for the GOA bottom trawl
and longline surveys</p></li>
</ul>
<p>Testing REMA across this range of complexity helps ensure that model
and model assumptions are valid in a variety of realistic,
management-relevant cases.</p>
<p>It is important to note that model validation does not mean the model
is “more right” or “more correct.” Model validation does not help an
analyst with model selection, except to identify models which are not
functioning properly, nor does it ensure that the model makes “better”
predictions. Rather, model validation is a way to ensure that the model
is operating as expected, without introducing bias or violating
statistical assumptions upon which the model is based (Auger‐Méthé et
al., 2016; Auger‐Méthé et al., 2021).</p>
<p>The key questions we aim to answer are:</p>
<ul>
<li>Does the model perform as expected, or does it introduce bias? Using
a simulation self-check, we will test if the model is coded correctly
and is able to recover known parameters.</li>
<li>Is it plausible that our data could have been generated by the
model? Using one-step ahead (OSA) residuals, the appropriate residual
type for state-space models, we test the model assumptions and look for
trends in residuals that may reveal characteristics or dynamics of the
data that aren’t adequately captured by the model.</li>
<li>Are the normality assumptions made when estimating random effects
via the Laplace approximation valid? By comparing a non-Laplace
approximation and a Laplace approximation of the model via MCMC, we test
if the distribution of the fixed effects parameters’ posteriors are
normal or normal-like.</li>
<li>Are the parameters unique and non-redundant? Checking the
correlation between parameters helps us identify if parameters are
redundant with each other.</li>
</ul>
</div>
<div class="section level3">
<h3 id="prepare-data-for-each-stock-here">Prepare data for each stock here<a class="anchor" aria-label="anchor" href="#prepare-data-for-each-stock-here"></a>
</h3>
<p>First, we run the model for each stock. The AI Pcod model (pcod_mod)
uses a single process error to describe the stock over time (one
parameter). The GOA thornyhead rockfish model (thrn_mod) uses data from
two surveys (bottom trawl and longline survey) to describe the stock
over time (six fixed effects parameters: three process errors, one
scaling parameter, additional observation error for the biomass survey,
and additional observation error for the longline survey).</p>
<p>In the code below, we show how to specify and fit these models within
the <code>rema</code> framework and plot fits to the data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">415</span><span class="op">)</span> <span class="co"># for reproducibility, use a seed</span></span>
<span></span>
<span><span class="co"># first, get the p-cod data set up</span></span>
<span><span class="va">pcod_bio_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"ai_pcod_2022_biomass_dat.csv"</span><span class="op">)</span></span>
<span><span class="va">pcod_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_rema_input.html">prepare_rema_input</a></span><span class="op">(</span>model_name <span class="op">=</span> <span class="st">"p_cod"</span>,</span>
<span>                                 biomass_dat <span class="op">=</span> <span class="va">pcod_bio_dat</span>,</span>
<span>                                 <span class="co"># one strata</span></span>
<span>                                 PE_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pointer_PE_biomass <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>                                 <span class="op">)</span></span>
<span><span class="co"># run the model</span></span>
<span><span class="va">pcod_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_rema.html">fit_rema</a></span><span class="op">(</span><span class="va">pcod_input</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># next, get the thornyhead data set up</span></span>
<span><span class="va">thrn_bio_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"goa_thornyhead_2022_biomass_dat.csv"</span><span class="op">)</span></span>
<span><span class="va">thrn_cpue_dat</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"goa_thornyhead_2022_cpue_dat.csv"</span><span class="op">)</span></span>
<span><span class="va">thrn_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_rema_input.html">prepare_rema_input</a></span><span class="op">(</span>model_name <span class="op">=</span> <span class="st">'thrnhead_rockfish'</span>,</span>
<span>                                multi_survey <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                biomass_dat <span class="op">=</span> <span class="va">thrn_bio_dat</span>,</span>
<span>                                cpue_dat <span class="op">=</span> <span class="va">thrn_cpue_dat</span>,</span>
<span>                                <span class="co"># RPWs are a summable/area-weighted effort index</span></span>
<span>                                sum_cpue_index <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                                <span class="co"># three process error parameters (log_PE) estimated,</span></span>
<span>                                <span class="co"># indexed as follows for each biomass survey stratum</span></span>
<span>                                <span class="co"># (shared within an area across depths):</span></span>
<span>                                PE_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pointer_PE_biomass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                <span class="co"># scaling parameter options:</span></span>
<span>                                q_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                                <span class="co"># longline survey strata (n=3) indexed as follows for the</span></span>
<span>                                <span class="co"># biomass strata (n=9)</span></span>
<span>                                pointer_biomass_cpue_strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>                                <span class="co"># one scaling parameters (log_q) estimated, shared</span></span>
<span>                                <span class="co"># over all three LLS strata</span></span>
<span>                                pointer_q_cpue <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                <span class="co"># estimate extra trawl survey observation error</span></span>
<span>                                extra_biomass_cv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>assumption <span class="op">=</span> <span class="st">'extra_cv'</span><span class="op">)</span>,</span>
<span>                                <span class="co"># estimate extra longline survey observation error</span></span>
<span>                                extra_cpue_cv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>assumption <span class="op">=</span> <span class="st">'extra_cv'</span><span class="op">)</span></span>
<span>                                <span class="op">)</span></span>
<span></span>
<span><span class="co"># run the model</span></span>
<span><span class="va">thrn_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_rema.html">fit_rema</a></span><span class="op">(</span><span class="va">thrn_input</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># tidy output and plot fitted data</span></span>
<span><span class="va">tidy_pcod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tidy_rema.html">tidy_rema</a></span><span class="op">(</span><span class="va">pcod_mod</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_rema.html">plot_rema</a></span><span class="op">(</span><span class="va">tidy_pcod</span><span class="op">)</span><span class="op">$</span><span class="va">biomass_by_strata</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Model Fits to the AI Pcod Data"</span>,</span>
<span>          subtitle <span class="op">=</span> <span class="st">"Trawl Survey Biomass Strata"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">pred_lci</span>, ymax <span class="op">=</span> <span class="va">pred_uci</span><span class="op">)</span>,</span>
<span>              col <span class="op">=</span> <span class="st">'goldenrod'</span>, fill <span class="op">=</span> <span class="st">'goldenrod'</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">obs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, ymin <span class="op">=</span> <span class="va">obs_lci</span>, ymax <span class="op">=</span> <span class="va">obs_uci</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p1</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"vignettes/ex4_pcod_fits.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">6</span>, height <span class="op">=</span> <span class="fl">4</span>, units <span class="op">=</span> <span class="st">"in"</span>, bg <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tidy_thrn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tidy_rema.html">tidy_rema</a></span><span class="op">(</span><span class="va">thrn_mod</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_rema.html">plot_rema</a></span><span class="op">(</span><span class="va">tidy_thrn</span>, biomass_ylab <span class="op">=</span> <span class="st">'Biomass (t)'</span><span class="op">)</span><span class="op">$</span><span class="va">biomass_by_strata</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Model Fits to the GOA Thornyhead Data"</span>,</span>
<span>          subtitle <span class="op">=</span> <span class="st">"Trawl Survey Biomass Strata"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">pred_lci</span>, ymax <span class="op">=</span> <span class="va">pred_uci</span><span class="op">)</span>,</span>
<span>              col <span class="op">=</span> <span class="st">"#21918c"</span>, fill <span class="op">=</span> <span class="st">"#21918c"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">obs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, ymin <span class="op">=</span> <span class="va">obs_lci</span>, ymax <span class="op">=</span> <span class="va">obs_uci</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p2</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_rema.html">plot_rema</a></span><span class="op">(</span><span class="va">tidy_thrn</span>, cpue_ylab <span class="op">=</span> <span class="st">"RPW"</span><span class="op">)</span><span class="op">$</span><span class="va">cpue_by_strata</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span>label <span class="op">=</span> <span class="cn">NULL</span>, subtitle <span class="op">=</span> <span class="st">"Longline Survey Relative Population Weight (RPW) Strata"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">pred_lci</span>, ymax <span class="op">=</span> <span class="va">pred_uci</span><span class="op">)</span>,</span>
<span>              col <span class="op">=</span> <span class="st">"#21918c"</span>, fill <span class="op">=</span> <span class="st">"#21918c"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">obs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, ymin <span class="op">=</span> <span class="va">obs_lci</span>, ymax <span class="op">=</span> <span class="va">obs_uci</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p3</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p2</span>, <span class="va">p3</span>, rel_heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.3</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"vignettes/ex4_thrn_fits.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">11</span>, height <span class="op">=</span> <span class="fl">10</span>, units <span class="op">=</span> <span class="st">"in"</span>, bg <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span></code></pre></div>
<p>The figures below show fits the data for AI Pcod and GOA Thornyhead.
In particular, the GOA Thornyhead fits show a trade off between the
biomass and longline survey data. <img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_fits.png" style="width:10in"></p>
</div>
<div class="section level3">
<h3 id="simulation-self-test-can-we-recover-parameters-without-bias">1. Simulation self-test: Can we recover parameters without
bias?<a class="anchor" aria-label="anchor" href="#simulation-self-test-can-we-recover-parameters-without-bias"></a>
</h3>
<p>Simulation testing is an important step to ensure the model has been
properly coded and performs consistently without introducing bias
(Auger‐Méthé et al., 2021; Gimenez et al., 2004). First, we use the REMA
model to estimate parameters (e.g., process error variance) from the
real data in the AI Pcod and GOA Thornyhead case studies. Next, we use
the estimated parameters as “true” values to simulate new data
(simulated observations and states) using the REMA equations. For AI
Pcod each simulated data set is a biomass trajectory, and for GOA
Thornyhead it includes biomass trajectories in nine strata and longline
survey relative population weights (RPWs) in three strata. We use the
REMA model to re-estimate the model parameters and calculate the
relative error (RE; i.e., (true-estimated values)/true value*100)) for
the parameters in each simulation replicate (N=500).</p>
<p>Models fail this simulation testing when the recovered parameters are
biased, or deviate consistently from the true values used to simulate
data. If the recovered parameters are far from the true values or the
span of the recovered parameters is large, this may indicate that the
model has a coding, is non-identifiable, has redundant parameters, or is
bias (i.e., there is some other kind of model misspecification).</p>
<p>The following function runs a simulation self-test for a REMA
model.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">sim_test</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mod_name</span>, <span class="va">replicates</span>, <span class="va">cpue</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># storage things</span></span>
<span>  <span class="va">re_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">replicates</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mod_name</span><span class="op">$</span><span class="va">par</span><span class="op">)</span><span class="op">)</span> <span class="co"># parameter estimates</span></span>
<span></span>
<span>  <span class="co"># go through the model</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">replicates</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">sim</span> <span class="op">&lt;-</span> <span class="va">mod_name</span><span class="op">$</span><span class="fu">simulate</span><span class="op">(</span>complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># simulates the data</span></span>
<span></span>
<span>    <span class="co"># simulated biomass observations:</span></span>
<span>    <span class="va">tmp_biomass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">log_biomass_obs</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">mod_name</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">biomass_obs</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tmp_biomass</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mod_name</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">biomass_obs</span><span class="op">)</span></span>
<span>    <span class="co"># simulated cpue observations, when applicable:</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">cpue</span><span class="op">)</span> <span class="op">{</span><span class="va">tmp_cpue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">cpue_obs</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">mod_name</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">cpue_obs</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tmp_cpue</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mod_name</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">cpue_obs</span><span class="op">)</span><span class="op">}</span></span>
<span>    <span class="co"># set up new data for input</span></span>
<span>    <span class="va">newinput</span> <span class="op">&lt;-</span> <span class="va">mod_name</span><span class="op">$</span><span class="va">input</span></span>
<span>    <span class="va">newinput</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">biomass_obs</span> <span class="op">&lt;-</span> <span class="va">tmp_biomass</span> <span class="co"># biomass data</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">cpue</span><span class="op">)</span> <span class="op">{</span><span class="va">newinput</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">cpue_obs</span> <span class="op">&lt;-</span> <span class="va">tmp_cpue</span><span class="op">}</span> <span class="co"># cpue data</span></span>
<span></span>
<span>    <span class="co"># create "obsvec" which is used internally in cpp file as the observation</span></span>
<span>    <span class="co"># vector for all observation (log biomass + cpue) in the likelihood</span></span>
<span>    <span class="co"># functions (and required for OSA residuals). note the transpose t() needed</span></span>
<span>    <span class="co"># to get these matrices in the correct order (by row instead of by col) --</span></span>
<span>    <span class="co"># note obsvec is masked from users normally in prepare_rema_input()</span></span>
<span>    <span class="va">newinput</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">obsvec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">log_biomass_obs</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">log_biomass_obs</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">cpue</span><span class="op">)</span> <span class="op">{</span><span class="va">newinput</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">obsvec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">log_biomass_obs</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">log_biomass_obs</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">log_cpue_obs</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">log_cpue_obs</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">}</span></span>
<span></span>
<span>    <span class="co"># refit model</span></span>
<span>    <span class="va">mod_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_rema.html">fit_rema</a></span><span class="op">(</span><span class="va">newinput</span>, do.sdrep <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># add parameter estimates to matrix</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">mod_new</span><span class="op">$</span><span class="va">opt</span><span class="op">$</span><span class="va">convergence</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">re_est</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mod_new</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mod_name</span><span class="op">$</span><span class="va">par</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">re_est</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mod_name</span><span class="op">$</span><span class="va">par</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">re_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">re_est</span><span class="op">)</span>; <span class="va">re_est</span><span class="op">$</span><span class="va">type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"recovered"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">re_est</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Run self-test for AI Pcod and GOA Thornyhead and examine results.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># run for pcod and prep data frame</span></span>
<span><span class="co"># run simulation testing</span></span>
<span><span class="va">par_ests</span> <span class="op">&lt;-</span> <span class="fu">sim_test</span><span class="op">(</span>mod_name <span class="op">=</span> <span class="va">pcod_mod</span>, replicates <span class="op">=</span> <span class="fl">500</span>, cpue <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># get data frame with simulation values for each parameter</span></span>
<span><span class="va">n_not_converged_pcod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">par_ests</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>; <span class="va">n_pcod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">par_ests</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">prop_converged_pcod</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">-</span><span class="va">n_not_converged_pcod</span><span class="op">/</span><span class="va">n_pcod</span></span>
<span></span>
<span><span class="va">mod_par_ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"log_PE1"</span> <span class="op">=</span> <span class="va">pcod_mod</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                           type <span class="op">=</span> <span class="st">"model"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par_ests</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mod_par_ests</span><span class="op">)</span> <span class="co"># rename for ease</span></span>
<span><span class="va">pcod_par_ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">mod_par_ests</span>, <span class="va">par_ests</span><span class="op">)</span> <span class="co"># recovered and model in one data frame</span></span>
<span><span class="va">pcod_par_ests</span><span class="op">$</span><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"AI Pcod"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># run for thorny and prep data frame -- same process</span></span>
<span><span class="co"># run simulation testing</span></span>
<span><span class="va">par_ests</span> <span class="op">&lt;-</span> <span class="fu">sim_test</span><span class="op">(</span>mod_name <span class="op">=</span> <span class="va">thrn_mod</span>, replicates <span class="op">=</span> <span class="fl">500</span>, cpue <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># note some warnings</span></span>
<span><span class="co"># sometimes spits out: In stats::nlminb(model$par, model$fn, model$gr, control =</span></span>
<span><span class="co"># list(iter.max = 1000,...: NA/NaN function evaluation</span></span>
<span><span class="va">n_not_converged_thrn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">par_ests</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>; <span class="va">n_thrn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">par_ests</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">prop_converged_thrn</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">-</span><span class="va">n_not_converged_thrn</span><span class="op">/</span><span class="va">n_thrn</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">par_ests</span><span class="op">)</span></span>
<span><span class="co"># get data frame with simulation values for each parameter</span></span>
<span><span class="va">mod_par_ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"log_PE1"</span> <span class="op">=</span> <span class="va">thrn_mod</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                           <span class="st">"log_PE2"</span> <span class="op">=</span> <span class="va">thrn_mod</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>                           <span class="st">"log_PE3"</span> <span class="op">=</span> <span class="va">thrn_mod</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>                           <span class="st">"log_q"</span> <span class="op">=</span> <span class="va">thrn_mod</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,</span>
<span>                           <span class="st">"log_tau_biomass"</span> <span class="op">=</span> <span class="va">thrn_mod</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>,</span>
<span>                           <span class="st">"log_tau_cpue"</span> <span class="op">=</span> <span class="va">thrn_mod</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span>,</span>
<span>                           type <span class="op">=</span> <span class="st">"model"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par_ests</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mod_par_ests</span><span class="op">)</span> <span class="co"># rename for ease</span></span>
<span><span class="va">thrn_par_ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">mod_par_ests</span>, <span class="va">par_ests</span><span class="op">)</span> <span class="co"># recovered and model parameters in one data frame</span></span>
<span><span class="va">thrn_par_ests</span><span class="op">$</span><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"GOA Thornyhead"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># reogranize data</span></span>
<span><span class="va">pcod_sim</span> <span class="op">&lt;-</span> <span class="va">pcod_par_ests</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">pivot_longer</span><span class="op">(</span><span class="fl">1</span>, names_to <span class="op">=</span> <span class="st">"parameter"</span><span class="op">)</span></span>
<span><span class="va">thrn_sim</span> <span class="op">&lt;-</span> <span class="va">thrn_par_ests</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">pivot_longer</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, names_to <span class="op">=</span> <span class="st">"parameter"</span><span class="op">)</span></span>
<span><span class="va">sim_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">pcod_sim</span>, <span class="va">thrn_sim</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Relative Error: ((om-em)/om)</span></span>
<span><span class="va">sim_re</span> <span class="op">&lt;-</span> <span class="va">sim_dat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sp"</span>, <span class="st">"parameter"</span><span class="op">)</span>,</span>
<span>              names_from <span class="op">=</span> <span class="va">type</span>, values_from <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">recovered</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>RE <span class="op">=</span> <span class="op">(</span><span class="va">model</span><span class="op">-</span><span class="va">recovered</span><span class="op">)</span><span class="op">/</span><span class="va">model</span><span class="op">*</span><span class="fl">100</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">sp</span>, <span class="va">parameter</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Median RE="</span>, <span class="fu"><a href="https://rdrr.io/r/base/formatc.html" class="external-link">formatC</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">RE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, format <span class="op">=</span> <span class="st">"f"</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="st">"%"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot distribution of simulated parameter estimates</span></span>
<span><span class="va">plot_sim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim_dat</span>, <span class="va">plot_title</span>, <span class="va">fill_col</span> <span class="op">=</span> <span class="st">"#21918c"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># add distribution of recovered parameters</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html" class="external-link">geom_violin</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim_dat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"recovered"</span><span class="op">)</span>,</span>
<span>                fill <span class="op">=</span> <span class="va">fill_col</span>, alpha <span class="op">=</span> <span class="fl">0.6</span>, draw_quantiles <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># add "true values" from original model</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim_dat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"model"</span><span class="op">)</span>,</span>
<span>               size <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">parameter</span>, scales <span class="op">=</span> <span class="st">"free"</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"Parameter estimate"</span>, title <span class="op">=</span> <span class="va">plot_title</span>,</span>
<span>         subtitle <span class="op">=</span> <span class="st">"Distribution of parameters estimates (median=horizontal line, true value=point)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_x_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="cn">NULL</span>, breaks <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># plot relative error</span></span>
<span><span class="va">plot_re</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim_re</span>, <span class="va">fill_col</span> <span class="op">=</span> <span class="st">"#21918c"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="va">RE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># add distribution of recovered parameters</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim_re</span>, alpha <span class="op">=</span> <span class="fl">0.6</span>, fill <span class="op">=</span> <span class="va">fill_col</span>,</span>
<span>                 na.rm <span class="op">=</span> <span class="cn">TRUE</span>, outlier.size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># separate by parameter</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">parameter</span><span class="op">+</span><span class="va">label</span>, scales <span class="op">=</span> <span class="st">"free"</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="co">#, space = "free") +</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"Relative error (%)"</span>, subtitle <span class="op">=</span> <span class="st">"Distribution of relative error (RE; i.e., (true-estimated values)/true value*100)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_x_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="cn">NULL</span>, breaks <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">p1pcod</span> <span class="op">&lt;-</span> <span class="fu">plot_sim</span><span class="op">(</span><span class="va">pcod_sim</span>, <span class="st">"AI Pcod Simulation"</span>, fill_col <span class="op">=</span> <span class="st">"goldenrod"</span><span class="op">)</span></span>
<span><span class="va">p1thrn</span> <span class="op">&lt;-</span> <span class="fu">plot_sim</span><span class="op">(</span><span class="va">thrn_sim</span>, <span class="st">"GOA Thornyhead Simulation"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2pcod</span> <span class="op">&lt;-</span> <span class="fu">plot_re</span><span class="op">(</span><span class="va">sim_re</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sp</span> <span class="op">==</span> <span class="st">"AI Pcod"</span><span class="op">)</span>, fill_col <span class="op">=</span> <span class="st">"goldenrod"</span><span class="op">)</span></span>
<span><span class="va">p2thrn</span> <span class="op">&lt;-</span> <span class="fu">plot_re</span><span class="op">(</span><span class="va">sim_re</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sp</span> <span class="op">==</span> <span class="st">"GOA Thornyhead"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1pcod</span>, <span class="va">p2pcod</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"vignettes/ex4_sim_pcod.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">6.5</span>, height <span class="op">=</span> <span class="fl">7</span>, units <span class="op">=</span> <span class="st">"in"</span>, bg <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1thrn</span>, <span class="va">p2thrn</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"vignettes/ex4_sim_thrn.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">11</span>, height <span class="op">=</span> <span class="fl">7</span>, units <span class="op">=</span> <span class="st">"in"</span>, bg <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span></code></pre></div>
<p><strong>Results of the simulation self-test</strong></p>
<p>Only 1 out of 500 simulation replicates did not converge for the AI
Pcod model, which suggests a high degree of model stability. There were
11 out 500 simulation replicates for the GOA Thornyhead model that did
not converge. In the following figures the top panel shows the
distribution of resulting parameter estimates for the parameter
estimates in each of the models based on the simulations, where the
horizontal line is the median estimated value and the black dot is the
“true” value (i.e., the parameters estimates from the real data sets).
As demonstrated in the boxplots of the bottom panels in the figures
below, the parameters in both models are recovered well in simulation
testing, with low median relative error. In both models there are
instances of long negative tails in the log standard deviation of the
process error (log_PE), suggesting that PE was small or tended towards
zero in some simulations. This is also the case for the extra
observation error for the biomass survey (log_tau_biomass) in the GOA
Thornyhead model. These outlier replicates may shed light on why some
replicates failed to converge. Specifically, <code>nlminb</code>, the
optimizer used by <code>rema</code>, returned a
“<code>NA/NaN function evaluation</code>” error, which commonly means
the optimizer got “stuck” in a parameter space that is incompatible with
the assumptions of the model; e.g., PE wanted to be zero but couldn’t
because PE is log-transformed. The negative log-scale values are most
extreme for the GOA Thornyhead model, which should raise some concern of
potential model mispecification or over-parameterization. For example,
given the trade off between between process and observation error in
REMA, it is possible that the estimation of additional observation error
on the biomass survey may not be justified (a PE=0 is the same as taking
a global mean of the biomass time series).</p>
<!-- ![](ex4_sim_pcod.png){width="6in"} -->
<!-- ![](https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_sim_pcod.png){width="6in"} -->
<!-- ![](ex4_sim.png){width="10in"} -->
<p><img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_sim.png" style="width:10in"></p>
</div>
<div class="section level3">
<h3 id="residual-analysis">2. Residual analysis<a class="anchor" aria-label="anchor" href="#residual-analysis"></a>
</h3>
<p>Residuals are used to test the underlying assumptions about the error
distributions in the model. For example, in a linear regression,
residuals should be independent, normal, and have constant variance.
Traditional residuals (e.g., Pearson’s residuals) are inappropriate for
state-space models like REMA, because process error variance may be
over-estimated in cases where the model is mis-specified, thus leading
to artificially small residuals (see Section 3 of Thygesen et al. 2017
for an example). The appropriate residual type for validation of
state-space models are called one-step ahead (OSA) residuals. Instead of
comparing the observed and expected values at the same time step, OSA
residuals use forecasted values based on all previous observations
(i.e., they exclude the observed value at the current time step from
prediction). In this way, OSA residuals account for non-normality and
correlation among years. Under a correctly specified model, resultant
OSA residuals should be independent and identically distributed (i.i.d.)
with a standard normal distribution
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N(0,1)</annotation></semantics></math>.</p>
<p>Methods for calculating OSA residuals in REMA have been implemented
in the <code><a href="../reference/get_osa_residuals.html">rema::get_osa_residuals()</a></code> using the
<code><a href="https://rdrr.io/pkg/TMB/man/oneStepPredict.html" class="external-link">TMB::oneStepPredict()</a></code> function and the
<code>fullGaussian</code> method. The
<code><a href="../reference/get_osa_residuals.html">rema::get_osa_residuals()</a></code> returns tidied dataframes of
observations, REMA model predictions, and OSA residuals for the biomass
and CPUE survey data when appropriate, along with several diagnostic
plots.</p>
<p>One useful diagnostic plot provided in the output to
<code><a href="../reference/get_osa_residuals.html">rema::get_osa_residuals()</a></code> is the normal quantile-quantile
(QQ) plot, which can help users determine if the OSA residuals are
likely to have come from the expected standard normal distribution. In a
normal QQ plot, the quantile values of the standard normal distribution
are plotted on the x-axis, and the corresponding quantile values of the
OSA residuals are plotted on the y-axis. If the OSA residuals are
normally distributed, the points will fall on the 0/1 reference line. If
the residuals are not normally distributed, the points will deviate from
the reference line. OSA residuals are plotted for the entire data set
combined <code>$plots$qq</code> and by stratum for the biomass survey
<code>$plots$biomass_qq</code> or CPUE survey
<code>$plots$cpue_qq</code>. While it can be useful to check for
residual patterns by stratum, users should be aware that small sample
sizes may not have statistical power. In the top-left corner of the
combined QQ plot <code>$plots$qq</code>, we provide the standard
deviation of normalized residuals (SDNR) statistic. Given that OSA
residuals should be
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N(0,1)</annotation></semantics></math>
under a correctly specified model, we should expect the SDNR to be equal
to close to 1.</p>
<p>In addition to the normal QQ plots, we examine visual fits of the OSA
residuals by year in order to test for randomness or independence of the
residuals (i.e., they should not be correlated by year). Standard
approaches such as autocorrelation function (ACF) plots or residual runs
tests (e.g., Wald-Wolfowitz test) are inappropriate for many REMA
applications because of missing years of data in the survey time series.
Patterns in the residuals may indicate structure in the data (i.e.,
temporal correlation) that is not adequately captured by the model.
These figures are also useful for identifying outliers. Under the
assumed standard normal distribution, a residual is considered an
outlier when it is greater than 3 or less than -3.</p>
<p>The following code shows how to run an OSA residual analysis for AI
Pcod and GOA Thornyhead REMA models.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Pcod</span></span>
<span><span class="va">pcod_resid</span> <span class="op">&lt;-</span> <span class="fu">rema</span><span class="fu">::</span><span class="fu"><a href="../reference/get_osa_residuals.html">get_osa_residuals</a></span><span class="op">(</span><span class="va">pcod_mod</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">pcod_resid</span><span class="op">$</span><span class="va">plots</span><span class="op">$</span><span class="va">qq</span> <span class="op">+</span></span>
<span>                     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">'OSA Residuals for AI Pcod'</span><span class="op">)</span> <span class="op">+</span></span>
<span>                     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span>,</span>
<span>                   <span class="va">pcod_resid</span><span class="op">$</span><span class="va">plots</span><span class="op">$</span><span class="va">biomass_resids</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"vignettes/ex4_aipcod_osa.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">5.5</span>, height <span class="op">=</span> <span class="fl">7</span>, units <span class="op">=</span> <span class="st">"in"</span>, bg <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Thorny</span></span>
<span><span class="va">thrn_resid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_osa_residuals.html">get_osa_residuals</a></span><span class="op">(</span><span class="va">thrn_mod</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span><span class="va">thrn_resid</span><span class="op">$</span><span class="va">plots</span><span class="op">$</span><span class="va">qq</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">'OSA Residual QQ Plots for GOA Thornyhead'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">thrn_resid</span><span class="op">$</span><span class="va">plots</span><span class="op">$</span><span class="va">biomass_qq</span> <span class="op">+</span> <span class="co"># biomass data</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">'By Biomass Survey Strata'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="va">thrn_resid</span><span class="op">$</span><span class="va">plots</span><span class="op">$</span><span class="va">cpue_qq</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">'By Longline Survey Strata'</span><span class="op">)</span> <span class="op">+</span> <span class="co"># rpw data</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, <span class="va">p3</span>, ncol <span class="op">=</span> <span class="fl">1</span>, rel_heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"vignettes/ex4_thrn_osaqq.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">7.5</span>, height <span class="op">=</span> <span class="fl">11</span>, units <span class="op">=</span> <span class="st">"in"</span>, bg <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">thrn_resid</span><span class="op">$</span><span class="va">plots</span><span class="op">$</span><span class="va">biomass_resids</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">'OSA Residuals for GOA Thornyhead by Biomass Survey Strata'</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">thrn_resid</span><span class="op">$</span><span class="va">plots</span><span class="op">$</span><span class="va">cpue_resids</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">'By Longline Survey Strata'</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, ncol <span class="op">=</span> <span class="fl">1</span>, rel_heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.5</span>,<span class="fl">1.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"vignettes/ex4_thrn_osa.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">7.5</span>, height <span class="op">=</span> <span class="fl">8</span>, units <span class="op">=</span> <span class="st">"in"</span>, bg <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span></code></pre></div>
<p><strong>Results of the residual analysis</strong></p>
<p>The normal QQ plot plot for AI Pcod (top panel of the figure below)
suggests slight negative skewness in the residuals (i.e., the majority
of the points fall below the 0/1 line), though the small sample size
makes interpretation challenging. The SDNR is 0.99 (a perfect model
would have an SDNR=1.00), which means assumptions are likely not
violated for the residuals. The plot of OSA residuals by year (bottom
panel) shows no patterns in the residuals, suggesting they are
independent. There is no evidence of outliers that warrant further
inspection.</p>
<!-- ![](ex4_aipcod_osa.png){width="6in"} -->
<p><img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_aipcod_osa.png" style="width:6in"></p>
<p>The combined normal QQ plot for GOA Thornyhead OSA residuals (top
panel of the figure below) suggests they follow a normal distribution
(the points fall along the 0/1 line), though there is evidence of slight
positive, or right skewness (the majority of the points fall above the
0/1 line). The SDNR is exactly 1, indicating the variance assumptions
are likely met for the residuals. The QQ plots for the biomass by strata
(middle panels) highlight where some of the positive skewness may be
coming from (e.g., EGOA 701-1000m, WGOA 0-500 m); however, small sample
sizes by stratum make interpretation of these QQ plots difficult The QQ
plots for the CPUE by strata are mostly normal, though there some
evidence of light tails in the WGOA stratum (bottom panel).</p>
<!-- ![](ex4_thrn_osaqq.png){width="10in"} -->
<p><img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_thrn_osaqq.png" style="width:10in"></p>
<p>The plot of OSA residuals by year for the GOA Thornyhead OSA
residuals by biomass strata (top panels of the figure below) show no
patterns in the residuals, suggesting they are independent. However,
there are runs in the residuals for the CPUE strata (bottom panels of
the figure below), especially in the CGOA and WGOA, which may be
indicative of model misspecification or misfit. There is no evidence of
outliers.</p>
<!-- ![](ex4_thrn_osa.png){width="10in"} -->
<p><img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_thrn_osa.png" style="width:10in"></p>
</div>
<div class="section level3">
<h3 id="laplace-approximation-are-the-model-assumptions-related-to-random-effects-estimation-reasonable">3. Laplace approximation: Are the model assumptions related to
random effects estimation reasonable?<a class="anchor" aria-label="anchor" href="#laplace-approximation-are-the-model-assumptions-related-to-random-effects-estimation-reasonable"></a>
</h3>
<p>The <code>rema</code> library was developed in Template Model Builder
(<code>TMB</code>), which uses maximum marginal likelihood estimation
with the Laplace approximation to efficiently estimate high dimensional,
non-linear mixed effects models in a frequentist framework (Skaug and
Fournier, 2006; Kristensen et al., 2016). The primary assumption in
models using the Laplace approximation is that the random effects follow
a normal distribution. This assumption simplifies the complex integrals
that make up the likelihood function. The Laplace approximation is fast
and accurate when the normality assumption is met; however, if the true
distribution of the random effects is not normal, the Laplace
approximation may introduce bias into the parameter estimates.</p>
<p>We can test the validity of the Laplace approximation using Markov
chain Monte Carlo (MCMC) sampling in the <code>tmbstan</code> library,
comparing the distributions of the fixed effects parameters from
MCMC-sampled models with and without the Laplace approximation (Monnahan
and Kristensen, 2018). To do so, we compare the distributions using QQ
plots between the two model cases. The Laplace approximation is a
reasonable assumption if the sampling quantiles for the two models (with
and without the Laplace approximation) are similar, i.e., they fall on
the 1:1 line. This can also help us identify bias introduced by the
Laplace approximation, for example, if the median (50%) is different
when using the Laplace approximation.</p>
<p>The function below is used to run the two model cases:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># function to (1) run models with and without laplace approximation for</span></span>
<span><span class="co"># comparison and (2) return posterior data frames and models</span></span>
<span><span class="co"># function input: model (e.g., AI Pcod or GOA Thornyhead), number of iterations</span></span>
<span><span class="co"># (samples), number of chains</span></span>
<span><span class="va">mcmc_comp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mod_name</span>, <span class="va">it_numb</span>, <span class="va">chain_numb</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># set up MCMC chain information</span></span>
<span>  <span class="va">it_num</span> <span class="op">&lt;-</span> <span class="va">it_numb</span></span>
<span>  <span class="va">chain_num</span> <span class="op">&lt;-</span> <span class="va">chain_numb</span></span>
<span>  <span class="co"># mod_name = pcod_mod; it_num = 4000; chain_num = 4</span></span>
<span></span>
<span>  <span class="co"># run model with laplace approximation</span></span>
<span>  <span class="va">mod_la</span> <span class="op">&lt;-</span> <span class="fu">tmbstan</span><span class="op">(</span>obj <span class="op">=</span> <span class="va">mod_name</span>, chains <span class="op">=</span> <span class="va">chain_num</span>, init <span class="op">=</span> <span class="va">mod_name</span><span class="op">$</span><span class="va">par</span>, laplace <span class="op">=</span> <span class="cn">TRUE</span>, iter <span class="op">=</span> <span class="va">it_num</span><span class="op">)</span></span>
<span>  <span class="co"># run model without laplace approximation, i.e., all parameters fully estimated without assumptions of normality</span></span>
<span>  <span class="va">mod_mcmc</span> <span class="op">&lt;-</span> <span class="fu">tmbstan</span><span class="op">(</span>obj <span class="op">=</span> <span class="va">mod_name</span>, chains <span class="op">=</span> <span class="va">chain_num</span>, init <span class="op">=</span> <span class="va">mod_name</span><span class="op">$</span><span class="va">par</span>, laplace <span class="op">=</span> <span class="cn">FALSE</span>, iter <span class="op">=</span> <span class="va">it_num</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># posteriors as data frame</span></span>
<span>  <span class="va">post_la</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">mod_la</span><span class="op">)</span>; <span class="va">post_la</span><span class="op">$</span><span class="va">type</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="st">"la"</span><span class="op">)</span></span>
<span>  <span class="va">post_mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">mod_mcmc</span><span class="op">)</span>; <span class="va">post_mcmc</span> <span class="op">&lt;-</span> <span class="va">post_mcmc</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mod_name</span><span class="op">$</span><span class="va">par</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">post_mcmc</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">]</span>; <span class="va">post_mcmc</span><span class="op">$</span><span class="va">type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"mcmc"</span><span class="op">)</span></span>
<span>  <span class="co"># informational things... this is for getting the posterior draws, i.e., to</span></span>
<span>  <span class="co"># test traceplots and such</span></span>
<span>  <span class="va">post_la</span><span class="op">$</span><span class="va">chain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">chain_num</span>, each <span class="op">=</span> <span class="va">it_num</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">post_la</span><span class="op">$</span><span class="va">iter_num</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">it_num</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="va">chain_num</span><span class="op">)</span></span>
<span>  <span class="va">post_mcmc</span><span class="op">$</span><span class="va">chain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">chain_num</span>, each <span class="op">=</span> <span class="va">it_num</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">post_mcmc</span><span class="op">$</span><span class="va">iter_num</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">it_num</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="va">chain_num</span><span class="op">)</span></span>
<span>  <span class="va">post_draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">post_la</span>, <span class="va">post_mcmc</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># get quantiles</span></span>
<span>  <span class="va">qv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>  <span class="va">quant_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>quant <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                          la <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                          mcmc <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                          par <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">post_la</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co"># post_la has type, chains, lp, iteration number column that don"t count</span></span>
<span></span>
<span>    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>quant <span class="op">=</span> <span class="va">qv</span>,</span>
<span>                      la <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">post_la</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, probs <span class="op">=</span> <span class="va">qv</span><span class="op">)</span>,</span>
<span>                      mcmc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">post_mcmc</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, probs <span class="op">=</span> <span class="va">qv</span><span class="op">)</span>,</span>
<span>                      par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"V"</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">quant_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">quant_dat</span>, <span class="va">tmp</span><span class="op">)</span></span>
<span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">quant_dat</span>, <span class="va">post_draws</span>, <span class="va">mod_la</span>, <span class="va">mod_mcmc</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># run models</span></span>
<span><span class="va">pcod_comp</span> <span class="op">&lt;-</span> <span class="fu">mcmc_comp</span><span class="op">(</span>mod_name <span class="op">=</span> <span class="va">pcod_mod</span>, it_numb <span class="op">=</span> <span class="fl">5000</span>, chain_numb <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">thrn_comp_log_tau</span> <span class="op">&lt;-</span> <span class="fu">mcmc_comp</span><span class="op">(</span>mod_name <span class="op">=</span> <span class="va">thrn_mod</span>, it_numb <span class="op">=</span> <span class="fl">5000</span>, chain_numb <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> </span></code></pre></div>
<p>The following code uses the output from <code>mcmc_comp()</code> to
make a QQ plot to compare the posterior distributions of the parameters
between the MCMC models with and without the Laplace approximation:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># clean up data frame names by renaming things</span></span>
<span><span class="va">pcod_qq</span> <span class="op">&lt;-</span> <span class="va">pcod_comp</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">pcod_qq</span><span class="op">$</span><span class="va">par_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"log_PE1"</span><span class="op">)</span>; <span class="va">pcod_qq</span><span class="op">$</span><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"AI Pcod"</span><span class="op">)</span></span>
<span><span class="va">thrn_qq</span> <span class="op">&lt;-</span> <span class="va">thrn_comp_log_tau</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">thrn_qq</span><span class="op">$</span><span class="va">par_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">recode</a></span><span class="op">(</span><span class="va">thrn_qq</span><span class="op">$</span><span class="va">par</span>,</span>
<span>                           V1 <span class="op">=</span> <span class="st">"log_PE1"</span>,</span>
<span>                           V2 <span class="op">=</span> <span class="st">"log_PE2"</span>,</span>
<span>                           V3 <span class="op">=</span> <span class="st">"log_PE3"</span>,</span>
<span>                           V4 <span class="op">=</span> <span class="st">"log_q"</span>,</span>
<span>                           V5 <span class="op">=</span> <span class="st">"log_tau_biomass"</span>,</span>
<span>                           V6 <span class="op">=</span> <span class="st">"log_tau_cpue"</span><span class="op">)</span></span>
<span><span class="va">thrn_qq</span><span class="op">$</span><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"GOA Thornyhead"</span><span class="op">)</span></span>
<span><span class="va">qq_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">pcod_qq</span>, <span class="va">thrn_qq</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot</span></span>
<span><span class="va">plot_laplace_mcmc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">qq_dat</span>, <span class="va">plot_title</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">qq_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">mcmc</span>, <span class="va">la</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"lightgray"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">par_name</span>, scales <span class="op">=</span> <span class="st">"free"</span>, nrow <span class="op">=</span> <span class="fl">2</span>,  dir <span class="op">=</span> <span class="st">"v"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"MCMC"</span>, y <span class="op">=</span> <span class="st">"Laplace approx."</span>, title <span class="op">=</span> <span class="va">plot_title</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>          axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>          axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>          strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">plot_laplace_mcmc</span><span class="op">(</span><span class="va">pcod_qq</span>, <span class="st">"AI Pcod"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">plot_laplace_mcmc</span><span class="op">(</span><span class="va">thrn_qq</span>, <span class="st">"GOA Thornyhead"</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, rel_widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>,<span class="fl">0.6</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"vignettes/ex4_mcmc_qq.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">11</span>, height <span class="op">=</span> <span class="fl">7</span>, units <span class="op">=</span> <span class="st">"in"</span>, bg <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span></code></pre></div>
<p><strong>Results for testing the validity of the Laplace
approximation</strong></p>
<p>The compared quantiles from full MCMC testing (x-axis) and the
Laplace approximation (y-axis) are given with the black points in the
figure below. The gray line is the 1:1 line. Points that fall on the
gray line indicate that the quantile value is the same between the two
cases.</p>
<p>For the simpler AI Pcod model (left panel), the Laplace approximation
and full MCMC testing show a similar distribution, indicating that the
Laplace approximation is reasonable.</p>
<p>For the more complex GOA Thornyhead model (right panels), the
log_tau_biomass parameter shows significant deviations between the two
model cases. Moreover, there are significant unresolved sampling
problems of the log_tau_biomass parameter in both cases, indicating that
the Laplace approximation might be inappropriate and that further
investigation into model structure might be necessary.</p>
<!-- ![](ex4_mcmc_qq.png){width="10in"} -->
<p><img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_mcmc_qq.png" style="width:10in"></p>
</div>
<div class="section level3">
<h3 id="parameter-correlation-are-the-model-parameters-identifiable-and-non-redundant">4. Parameter correlation: Are the model parameters identifiable and
non-redundant?<a class="anchor" aria-label="anchor" href="#parameter-correlation-are-the-model-parameters-identifiable-and-non-redundant"></a>
</h3>
<p>Parameter redundancy refers to the idea that multiple parameters
contribute to the model in the same way. An intuitive case is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>∼</mo><msub><mi>β</mi><mn>1</mn></msub><mo>+</mo><msub><mi>β</mi><mn>2</mn></msub><mo>+</mo><mi>α</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">y \sim \beta_1 + \beta_2 + \alpha x</annotation></semantics></math>,
since the model could estimate many combinations of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mn>1</mn></msub><annotation encoding="application/x-tex">\beta_1</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mn>2</mn></msub><annotation encoding="application/x-tex">\beta_2</annotation></semantics></math>
which minimize the log-likelihood, i.e., the sampled parameters will be
correlated. To reduce redundancy,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>β</mi><mn>1</mn></msub><mo>+</mo><msub><mi>β</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\beta_1 + \beta_2</annotation></semantics></math>
can be redefined as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mn>0</mn></msub><annotation encoding="application/x-tex">\beta_0</annotation></semantics></math>.
In more complex, hierarchical models, parameter redundancy is not always
intuitive and can be solved by increasing the number of parameters
(Gimenez et al., 2004; Cole, 2019), but can be checked using various
diagnostics. One simple diagnostic is to check for parameter
correlations.</p>
<p>Using the MCMC sampling framework, we can check for parameter
correlations to help us identify possible redundancy in parameters using
the <code>bayesplot</code> library (Gabry et al., 2019; Gabry and Mahr,
2024). If the sampled parameters are identifiable and non-redundant, we
would see no correlation between parameters. For simplicity here, we
only use the model case with the Laplace approximation.</p>
<p>Note this is unnecessary for the AI Pcod model, since there is only
one fixed effect parameter estimated in that model.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p2_mcmc_thrn</span> <span class="op">&lt;-</span> <span class="fu">bayesplot</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-scatterplots.html" class="external-link">mcmc_pairs</a></span><span class="op">(</span><span class="va">thrn_comp_log_tau</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                      off_diag_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.8</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>                      pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"log_PE[1]"</span>, <span class="st">"log_PE[2]"</span>, <span class="st">"log_PE[3]"</span>,</span>
<span>                               <span class="st">"log_q"</span>, <span class="st">"log_tau_biomass"</span>, <span class="st">"log_tau_cpue"</span><span class="op">)</span>,</span>
<span>                      grid_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>top <span class="op">=</span> <span class="st">"GOA Thornyhead: Pairwise correlation matrix of the posterior draws"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span>plot <span class="op">=</span> <span class="va">p2_mcmc_thrn</span>, filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"vignettes/ex4_pairs_thrn.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">11</span>, height <span class="op">=</span> <span class="fl">8</span>, units <span class="op">=</span> <span class="st">"in"</span>, bg <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span></code></pre></div>
<p>The figure below shows a pairwise correlation matrix of the posterior
draws for the GOA Thornyhead model (the MCMC model with the Laplace
approximation), with histograms of the univariate marginal distributions
on the diagonal and a scatterplot of the bivariate distributions off the
diagonal. There are clear identifiability issues with the
log_tau_biomass parameter, which appears to have a bimodal
distributions. The pairwise scatterplots on the off-diagonals show that
this bimodality in log_tau_biomass is causing interactions (i.e.,
correlation) with almost all other parameters in the model. This
diagnostic is a clear indication that there is model mis-specification
that warrants further investigation.</p>
<!-- ![](ex4_pairs_thrn.png){width="10in"} -->
<p><img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_pairs_thrn.png" style="width:10in"></p>
</div>
<div class="section level3">
<h3 id="is-the-goa-thornyhead-model-really-converged">5. Is the GOA Thornyhead model really converged?<a class="anchor" aria-label="anchor" href="#is-the-goa-thornyhead-model-really-converged"></a>
</h3>
<p>Despite the poor diagnostics shown in this vignette for the GOA
Thornyhead model, the standard output in <code>TMB</code> and
<code>rema</code> suggests that this model is converged (i.e., it has a
low maximum gradient component and the standard error estimates appear
reasonable). Within the MCMC framework, we can look at the mixing of
MCMC across multiple chains using a diagnostic called a traceplot to
assess convergence. The following code shows how to do that within the
<code>rstan</code> library (Stan Development Team, 2024):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1_mcmc_pcod</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html" class="external-link">traceplot</a></span><span class="op">(</span><span class="va">pcod_comp</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Traceplots to assess mixing across Markov chains and convergence"</span>, subtitle <span class="op">=</span> <span class="st">"AI Pcod"</span><span class="op">)</span></span>
<span><span class="va">p1_mcmc_thrn</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html" class="external-link">traceplot</a></span><span class="op">(</span><span class="va">thrn_comp_log_tau</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span>label <span class="op">=</span> <span class="cn">NULL</span>, subtitle <span class="op">=</span> <span class="st">"GOA Thornyhead"</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1_mcmc_pcod</span>, <span class="va">p1_mcmc_thrn</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"vignettes/ex4_traceplots.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">11</span>, height <span class="op">=</span> <span class="fl">8</span>, units <span class="op">=</span> <span class="st">"in"</span>, bg <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span></code></pre></div>
<p>From the traceplots for both models in the figures below, we see that
the AI Pcod model MCMC chains are fully mixed and the model is converged
(top panel). However, for the GOA Thornyhead model (bottom panel), we
see that the estimation of additional observation error
(log_tau_biomass) is causing convergence issues and the MCMC chains are
not well mixed.</p>
<!-- ![](ex4_traceplots.png){width="10in"} -->
<p><img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_traceplots.png" style="width:10in"></p>
</div>
<div class="section level3">
<h3 id="why-should-we-care">Why should we care?<a class="anchor" aria-label="anchor" href="#why-should-we-care"></a>
</h3>
<p>The REMA model is used within the North Pacific Fishery Management
Council to obtain exploitable biomass estimates for Tier 4 crab and Tier
5 groundfish and as a method to apportion Acceptable Biological Catches
among management regions (Sullivan et al., 2022). So then if it’s
primary purpose is to smooth noisy survey biomass estimates (i.e., if
we’re using it as a fancy average), do we need to care about potential
red flags raised during model validation? In the case of the GOA
thornyhead model, for example, it appears there is an issue with the
estimation of the additional observation error, pointing to potential
over-parameterization of the model and/or parameter redundancy. Because
terminal year predictions from the REMA model are the quantities
directly used for management, and the estimation of additional
observation error by definition increases the “smoothness” of model
predictions, the answer is likely yes in this particular case.</p>
</div>
<div class="section level3">
<h3 id="preliminary-recommendations">Preliminary recommendations<a class="anchor" aria-label="anchor" href="#preliminary-recommendations"></a>
</h3>
<p>The model validation methods presented in this vignette are tools for
stock assessment scientists to evaluate existing models and guide
development of future models. From this analysis, we found the MCMC
diagnostics and OSA residuals to be the most useful diagnostics for the
REMA model, and we recommend they are explored for existing models using
multivariate configurations with multiple process errors, multi-survey
versions using CPUE indices like the longline survey, and models
estimating additional observation error. Additionally, we recommend
these model diagnostics be used when recommending new models for
management.</p>
</div>
<div class="section level3">
<h3 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<p>Aeberhard, W.H., Flemming, J.M., Nielsen, A. 2018. Review of
State-Space Models for Fisheries Science. Annual Review of Statistics
and Its Application, 5(1), 215-235. <a href="https://doi.org/10.1146/annurev-statistics-031017-100427" class="external-link uri">https://doi.org/10.1146/annurev-statistics-031017-100427</a></p>
<p>Auger-Méthé, M., Field, C., Albertsen, C.M., Derocher, A.E., Lewis,
M.A., Jonsen, I.D., Flemming, J.M. 2016. State-space models’ dirty
little secrets: even simple linear Gaussian models can have estimation
problems. Scientific reports, 6(1), 26677.</p>
<p>Auger‐Méthé, M., Newman, K., Cole, D., Empacher, F., Gryba, R., King,
A. Leos-Barajas, V., Flemming, J.M., Nielsen, A, Petris, G., Thomas, L.
2021. A guide to state–space modeling of ecological time series.
Ecological Monographs, 91(4), e01470.</p>
<p>Campbell, D., &amp; Lele, S. 2014. An ANOVA test for parameter
estimability using data cloning with application to statistical
inference for dynamic systems. Computational Statistics &amp; Data
Analysis, 70, 257-267.</p>
<p>Cole, D. J. 2019. Parameter redundancy and identifiability in hidden
Markov models. Metron, 77(2), 105-118.</p>
<p>Echave, K.B., Siwicke, K.A., Sullivan, J., Ferriss, B., and Hulson,
P.J.F. 2022. Assessment of the Thornyhead stock complex in the Gulf of
Alaska. In Stock assessment and fishery evaluation report for the
groundfish fisheries of the Gulf of Alaska. North Pacific Fishery
Management Council, 605 W. 4th. Avenue, Suite 306, Anchorage, AK 99501.
<a href="https://apps-afsc.fisheries.noaa.gov/Plan_Team/2022/GOAthorny.pdf" class="external-link uri">https://apps-afsc.fisheries.noaa.gov/Plan_Team/2022/GOAthorny.pdf</a></p>
<p>Gabry, J. and Mahr, T. 2024. bayesplot: Plotting for Bayesian Models.
R package version 1.11.1, <a href="https://mc-stan.org/bayesplot/" class="external-link uri">https://mc-stan.org/bayesplot/</a>.</p>
<p>Gabry, J., Simpson, D., Vehtari, A., Betancourt, M., Gelman, A. 2019.
Visualization in Bayesian workflow. J. R. Stat. Soc. A. (182) 389-402.
<a href="doi:10.1111/rssa.12378" class="uri">doi:10.1111/rssa.12378</a>
<a href="https://doi.org/10.1111/rssa.12378" class="external-link uri">https://doi.org/10.1111/rssa.12378</a>.</p>
<p>Kristensen, K., Nielsen, A., Berg, C.W., Skaug, H., Bell, B.M. 2016.
TMB: Automatic differentiation and Laplace approximation. J Stat Softw.
2016; 70(5):21. Epub 2016-04-04. <a href="https://doi.org/10.18637/jss.v070.i05" class="external-link uri">https://doi.org/10.18637/jss.v070.i05</a></p>
<p>Monnahan, C.C., &amp; Kristensen, K. 2018. No-U-turn sampling for
fast Bayesian inference in ADMB and TMB: Introducing the adnuts and
tmbstan R packages. PloS one, 13(5), e0197954.</p>
<p>Skaug, H.J., and Fournier, D.A. 2006. Automatic approximation of the
marginal likelihood in non-Gaussian hierarchical models. Computational
Statistics &amp; Data Analysis, 51(2), 699-709.</p>
<p>Spies, I., Barbeaux, S., Hulson, H., Ortiz, I. 2023. Assessment of
the Pacifc cod stock in the Aleutian Islands. In Stock assessment and
fishery evaluation report for the groundfish fisheries of the Bering Sea
and Aleutian Islands. North Pacific Fishery Management Council, 605 W.
4th. Avenue, Suite 306, Anchorage, AK 99501. <a href="https://apps-afsc.fisheries.noaa.gov/Plan_Team/2023/AIpcod.pdf" class="external-link uri">https://apps-afsc.fisheries.noaa.gov/Plan_Team/2023/AIpcod.pdf</a></p>
<p>Stan Development Team. 2024. RStan: the R interface to Stan. R
package version 2.32.6, <a href="https://mc-stan.org/" class="external-link uri">https://mc-stan.org/</a>.</p>
<p>Sullivan, J., Monnahan, C. Hulson, P. Ianelli, J. Thorson, J. Havron,
A. 2022. REMA: A consensus version of the random effects model for ABC
apportionment and Tier 4/5 assessments. Plan Team Report, Joint
Groundfish Plan Teams, North Pacific Fishery Management Council. 605 W
4th Ave, Suite 306 Anchorage, AK 99501. <a href="https://meetings.npfmc.org/CommentReview/DownloadFile?p=eaa760cf-8a4e-4c05-aa98-82615da1982a.pdf&amp;fileName=Tier%204_5%20Random%20Effects.pdf" class="external-link">Available
through the Oct 2022 Joint GPT e-Agenda</a>.</p>
<p>Thygesen, U.H., Albertsen, C.M., Berg, C.W., Kristensen, K., &amp;
Nielsen, A. 2017. Validation of ecological state space models using the
Laplace approximation. Environmental and Ecological Statistics, 24(2),
317-339. <a href="https://doi.org/10.1007/s10651-017-0372-4" class="external-link uri">https://doi.org/10.1007/s10651-017-0372-4</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jane Sullivan, Laurinne Balstad.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
