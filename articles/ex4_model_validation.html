<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>REMA model validation • rema</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="REMA model validation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rema</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/ex1_basics.html">REMA basics</a></li>
    <li><a class="dropdown-item" href="../articles/ex2_cpue.html">Fitting to an additional CPUE survey</a></li>
    <li><a class="dropdown-item" href="../articles/ex3_zeros.html">Strategies for handling zero biomass observations</a></li>
    <li><a class="dropdown-item" href="../articles/ex4_model_validation.html">REMA model validation</a></li>
    <li><a class="dropdown-item" href="../articles/rema_equations.html">REMA model equations</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/JaneSullivan-NOAA/rema/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>REMA model validation</h1>
                        <h4 data-toc-skip class="author">Laurinne J
Balstad, Jane Sullivan, and Cole Monnahan</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/JaneSullivan-NOAA/rema/blob/main/vignettes/ex4_model_validation.Rmd" class="external-link"><code>vignettes/ex4_model_validation.Rmd</code></a></small>
      <div class="d-none name"><code>ex4_model_validation.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h3>
<p>Fisheries stock assessments are moving towards state-space
estimation, which boasts a range of benefits, including separation and
estimation of observation and process error, a more elegant framework
for handling missing data, a high degree of flexibility with respect to
model architecture and inclusion of different data types, and the
potential for improved projections and predictive skill (Aeberhard et
al., 2018). The flexibility and relative ease of fitting state-space
models means they can increase in complexity and dimensionality rapidly.
While easy to fit, state-space models are often challenging to validate,
and even simple models can suffer from estimation issues that result in
biased inference (Auger‐Méthé et al., 2016).</p>
<p>At the North Pacific Fishery Management Council (NPFMC), the “random
effects model” (REMA) is by far the most common state-space model used
for fishery management (Sullivan et al., 2022). REMA is a state-space
random walk model that can be customized to estimate multiple process
errors, fit to an additional abundance index, or estimate additional
observation error. REMA is used to estimate biomass within Tier 5
groundfish and Tier 4 crab stock assessments and to apportion Acceptable
Biological Catches (ABCs) by management area for many stocks. Despite
the high impact of this model within the North Pacific fishery
management process, we have no standard model validation practices for
REMA.</p>
<p><strong>Our goals:</strong></p>
<ol style="list-style-type: decimal">
<li><p>Apply established state-space model validation techniques to real
life REMA examples.</p></li>
<li><p>Create a REMA model validation guide with clear descriptions of
each method and motivation for its use, an explanation of how to
interpret the model validation results, and reproducible code that will
run for all operational REMA models at the NPFMC.</p></li>
<li><p>Provide preliminary recommendations for REMA users and reviewers
on which model validation methods are most relevant and informative for
REMA.</p></li>
</ol>
<p>Interested but otherwise busy readers are encouraged to skip to the
“When should we care about failed model diagnostics?” and
“Recommendations” sections. Table 1 and Figures 6-8 show examples of a
REMA model failing model validation criteria.</p>
</div>
<div class="section level3">
<h3 id="a-testing-framework-for-rema-model-validation">A testing framework for REMA model validation<a class="anchor" aria-label="anchor" href="#a-testing-framework-for-rema-model-validation"></a>
</h3>
<p>In this analysis, we will be testing that (1) REMA is working as
expected (i.e., code has been implemented correctly and parameters are
estimated without bias), and (2) that the assumptions made when
parameterizing and estimating REMA are valid, including assumptions
related to random effects and error structure. We use two example
stocks:</p>
<ul>
<li><p>Aleutian Islands Pacific cod (AI Pcod; Spies et al., 2023): a
simple, univariate case, which fits to a single time series of the AI
bottom trawl survey and estimates one process error</p></li>
<li><p>Gulf of Alaska Thornyhead rockfish (GOA thornyhead; Echave et
al., 2022): a complex, multi-strata and multi-survey case, which
estimates multiple process errors, a scaling parameter for the longline
survey, and two additional observation errors for the GOA bottom trawl
and longline surveys</p></li>
</ul>
<p>Both models appear to converge per standard REMA and TMB diagnostics
(small maximum gradient, invertible Hessian), and fit the data
reasonably, with model fits shown in Figure 1. These stocks span the
levels of complexity of NPFMC REMA models; testing REMA across this
range of complexity helps ensure that model and model assumptions are
valid in a variety of realistic, management-relevant cases.</p>
<p>It is important to note that model validation does not mean the model
is “more right” or “more correct.” Model validation does not help an
analyst with model selection (except to identify models that might not
function properly), nor does it ensure that the model makes “better”
predictions. Rather, model validation is a way to ensure that the model
is operating as expected, without introducing bias or violating
statistical assumptions upon which the model is based (Auger‐Méthé et
al., 2016; Auger‐Méthé et al., 2021), and that the data reasonably could
have come from the model (Thygesen et al., 2017).</p>
<p>The key questions we aim to answer with model validation include the
following:</p>
<ol style="list-style-type: decimal">
<li><p>Does the model perform as expected, or does it introduce bias?
Using a simulation self-check, we will test if the model is coded
correctly and is able to recover known parameters.</p></li>
<li><p>Is it plausible that our data could have been generated by the
model? Using one-step ahead (OSA) residuals, the appropriate residual
type for state-space models, we test the model assumptions and look for
trends in residuals that reveal characteristics or dynamics of the data
that aren’t adequately captured by the model.</p></li>
<li><p>Are the normality assumptions made when estimating random effects
via the Laplace approximation accurate? By comparing the posterior
distribution of fixed effects with and without the Laplace
approximation, we test whether the distribution of the random effects
are normal and thus the accuracy of the Laplace approximation. This
allows us to test the accuracy of the fixed effects estimates with
uncertainties.</p></li>
<li><p>Are the parameters unique and non-redundant? Checking the
correlation between parameters helps us identify if parameters are
redundant with each other.</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="prepare-data-for-each-stock-here">Prepare data for each stock here<a class="anchor" aria-label="anchor" href="#prepare-data-for-each-stock-here"></a>
</h3>
<p>First, we run the model for each stock. The AI Pcod model (pcod_mod)
uses a single process error to describe the stock over time (one
parameter). The GOA thornyhead rockfish model (thrn_mod) uses data from
two surveys (bottom trawl and longline survey) to describe the stock
over time (six fixed effects parameters: three process errors, one
scaling parameter, additional observation error for the biomass survey,
and additional observation error for the longline survey).</p>
<p>In the code below, we show how to specify and fit these models within
the <code>rema</code> framework and plot fits to the data. Figure 1
shows the fits to the data for AI Pcod and GOA Thornyhead. In
particular, the GOA Thornyhead fits show a trade off between the biomass
and longline survey data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">415</span><span class="op">)</span> <span class="co"># for reproducibility, use a seed</span></span>
<span></span>
<span><span class="co"># first, get the p-cod data set up</span></span>
<span><span class="va">pcod_bio_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"ai_pcod_2022_biomass_dat.csv"</span><span class="op">)</span></span>
<span><span class="va">pcod_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_rema_input.html">prepare_rema_input</a></span><span class="op">(</span>model_name <span class="op">=</span> <span class="st">"p_cod"</span>,</span>
<span>                                 biomass_dat <span class="op">=</span> <span class="va">pcod_bio_dat</span>,</span>
<span>                                 <span class="co"># one strata</span></span>
<span>                                 PE_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pointer_PE_biomass <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>                                 <span class="op">)</span></span>
<span><span class="co"># run the model</span></span>
<span><span class="va">pcod_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_rema.html">fit_rema</a></span><span class="op">(</span><span class="va">pcod_input</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># next, get the thornyhead data set up</span></span>
<span><span class="va">thrn_bio_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"goa_thornyhead_2022_biomass_dat.csv"</span><span class="op">)</span></span>
<span><span class="va">thrn_cpue_dat</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"goa_thornyhead_2022_cpue_dat.csv"</span><span class="op">)</span></span>
<span><span class="va">thrn_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_rema_input.html">prepare_rema_input</a></span><span class="op">(</span>model_name <span class="op">=</span> <span class="st">'thrnhead_rockfish'</span>,</span>
<span>                                multi_survey <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                biomass_dat <span class="op">=</span> <span class="va">thrn_bio_dat</span>,</span>
<span>                                cpue_dat <span class="op">=</span> <span class="va">thrn_cpue_dat</span>,</span>
<span>                                <span class="co"># RPWs are a summable/area-weighted effort index</span></span>
<span>                                sum_cpue_index <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                                <span class="co"># three process error parameters (log_PE) estimated,</span></span>
<span>                                <span class="co"># indexed as follows for each biomass survey stratum</span></span>
<span>                                <span class="co"># (shared within an area across depths):</span></span>
<span>                                PE_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pointer_PE_biomass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                <span class="co"># scaling parameter options:</span></span>
<span>                                q_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                                <span class="co"># longline survey strata (n=3) indexed as follows for the</span></span>
<span>                                <span class="co"># biomass strata (n=9)</span></span>
<span>                                pointer_biomass_cpue_strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>                                <span class="co"># one scaling parameters (log_q) estimated, shared</span></span>
<span>                                <span class="co"># over all three LLS strata</span></span>
<span>                                pointer_q_cpue <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                <span class="co"># estimate extra trawl survey observation error</span></span>
<span>                                extra_biomass_cv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>assumption <span class="op">=</span> <span class="st">'extra_cv'</span><span class="op">)</span>,</span>
<span>                                <span class="co"># estimate extra longline survey observation error</span></span>
<span>                                extra_cpue_cv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>assumption <span class="op">=</span> <span class="st">'extra_cv'</span><span class="op">)</span></span>
<span>                                <span class="op">)</span></span>
<span></span>
<span><span class="co"># run the model</span></span>
<span><span class="va">thrn_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_rema.html">fit_rema</a></span><span class="op">(</span><span class="va">thrn_input</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># tidy output and plot fitted data</span></span>
<span><span class="va">tidy_pcod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tidy_rema.html">tidy_rema</a></span><span class="op">(</span><span class="va">pcod_mod</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_rema.html">plot_rema</a></span><span class="op">(</span><span class="va">tidy_pcod</span><span class="op">)</span><span class="op">$</span><span class="va">biomass_by_strata</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Model Fits to the AI Pcod Data"</span>,</span>
<span>          subtitle <span class="op">=</span> <span class="st">"Trawl Survey Biomass Strata"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">pred_lci</span>, ymax <span class="op">=</span> <span class="va">pred_uci</span><span class="op">)</span>,</span>
<span>              col <span class="op">=</span> <span class="st">'goldenrod'</span>, fill <span class="op">=</span> <span class="st">'goldenrod'</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">obs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, ymin <span class="op">=</span> <span class="va">obs_lci</span>, ymax <span class="op">=</span> <span class="va">obs_uci</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p1</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"vignettes/ex4_pcod_fits.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">6</span>, height <span class="op">=</span> <span class="fl">4</span>, units <span class="op">=</span> <span class="st">"in"</span>, bg <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tidy_thrn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tidy_rema.html">tidy_rema</a></span><span class="op">(</span><span class="va">thrn_mod</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_rema.html">plot_rema</a></span><span class="op">(</span><span class="va">tidy_thrn</span>, biomass_ylab <span class="op">=</span> <span class="st">'Biomass (t)'</span><span class="op">)</span><span class="op">$</span><span class="va">biomass_by_strata</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Model Fits to the GOA Thornyhead Data"</span>,</span>
<span>          subtitle <span class="op">=</span> <span class="st">"Trawl Survey Biomass Strata"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">pred_lci</span>, ymax <span class="op">=</span> <span class="va">pred_uci</span><span class="op">)</span>,</span>
<span>              col <span class="op">=</span> <span class="st">"#21918c"</span>, fill <span class="op">=</span> <span class="st">"#21918c"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">obs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, ymin <span class="op">=</span> <span class="va">obs_lci</span>, ymax <span class="op">=</span> <span class="va">obs_uci</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p2</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_rema.html">plot_rema</a></span><span class="op">(</span><span class="va">tidy_thrn</span>, cpue_ylab <span class="op">=</span> <span class="st">"RPW"</span><span class="op">)</span><span class="op">$</span><span class="va">cpue_by_strata</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span>label <span class="op">=</span> <span class="cn">NULL</span>, subtitle <span class="op">=</span> <span class="st">"Longline Survey Relative Population Weight (RPW) Strata"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">pred_lci</span>, ymax <span class="op">=</span> <span class="va">pred_uci</span><span class="op">)</span>,</span>
<span>              col <span class="op">=</span> <span class="st">"#21918c"</span>, fill <span class="op">=</span> <span class="st">"#21918c"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">obs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, ymin <span class="op">=</span> <span class="va">obs_lci</span>, ymax <span class="op">=</span> <span class="va">obs_uci</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p3</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p2</span>, <span class="va">p3</span>, rel_heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.3</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"vignettes/ex4_thrn_fits.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">11</span>, height <span class="op">=</span> <span class="fl">10</span>, units <span class="op">=</span> <span class="st">"in"</span>, bg <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_fits.png" style="width:10in"></p>
<p><em>Figure 1.</em> <em>Fits to the AI Pcod (top panel; gold) and GOA
Thornyhead (bottom panels; teal) models.</em></p>
</div>
<div class="section level3">
<h3 id="simulation-self-test-can-we-recover-parameters-without-bias">1. Simulation self-test: Can we recover parameters without
bias?<a class="anchor" aria-label="anchor" href="#simulation-self-test-can-we-recover-parameters-without-bias"></a>
</h3>
<p>Simulation testing ensures the model has been properly coded and
performs consistently without introducing bias (Auger‐Méthé et al.,
2021; Gimenez et al., 2004). First, we use the REMA model to estimate
parameters (e.g., process error variance) from the real data. Next, we
use the estimated parameters as “true values” to simulate new latent
states (random effects) and data conditioned on the states using the
REMA equations. We then use the REMA model to re-estimate the model
parameters (“recovered parameters”) and calculate the relative error
(RE; i.e., (true-estimated values)/true value*100)) for the parameters
in each simulation replicate (N=500). The AI Pcod model is fitted to
bottom trawl data and each simulated data set is a biomass trajectory;
the GOA Thornyhead model is fitted to bottom trawl and longline survey
data, and each simulation data set includes biomass trajectories in nine
strata and longline survey relative population weights (RPWs) in three
strata.</p>
<p>Models fail this simulation testing when the recovered parameters are
biased (RE ≠ 0), or deviate consistently from the true values used to
simulate data (span of the recovered parameters is large): this can
indicate that the model has a coding error, is non-identifiable, has
redundant parameters, or is biased (i.e., there is some other kind of
model misspecification).</p>
<p>The following function runs a simulation self-test for a REMA
model.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">sim_test</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mod_name</span>, <span class="va">replicates</span>, <span class="va">cpue</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># storage things</span></span>
<span>  <span class="va">re_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">replicates</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mod_name</span><span class="op">$</span><span class="va">par</span><span class="op">)</span><span class="op">)</span> <span class="co"># parameter estimates</span></span>
<span></span>
<span>  <span class="co"># go through the model</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">replicates</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">sim</span> <span class="op">&lt;-</span> <span class="va">mod_name</span><span class="op">$</span><span class="fu">simulate</span><span class="op">(</span>complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># simulates the data</span></span>
<span></span>
<span>    <span class="co"># simulated biomass observations:</span></span>
<span>    <span class="va">tmp_biomass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">log_biomass_obs</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">mod_name</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">biomass_obs</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tmp_biomass</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mod_name</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">biomass_obs</span><span class="op">)</span></span>
<span>    <span class="co"># simulated cpue observations, when applicable:</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">cpue</span><span class="op">)</span> <span class="op">{</span><span class="va">tmp_cpue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">cpue_obs</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">mod_name</span><span class="op">$</span><span class="va">input</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">cpue_obs</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tmp_cpue</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mod_name</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">cpue_obs</span><span class="op">)</span><span class="op">}</span></span>
<span>    <span class="co"># set up new data for input</span></span>
<span>    <span class="va">newinput</span> <span class="op">&lt;-</span> <span class="va">mod_name</span><span class="op">$</span><span class="va">input</span></span>
<span>    <span class="va">newinput</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">biomass_obs</span> <span class="op">&lt;-</span> <span class="va">tmp_biomass</span> <span class="co"># biomass data</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">cpue</span><span class="op">)</span> <span class="op">{</span><span class="va">newinput</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">cpue_obs</span> <span class="op">&lt;-</span> <span class="va">tmp_cpue</span><span class="op">}</span> <span class="co"># cpue data</span></span>
<span></span>
<span>    <span class="co"># create "obsvec" which is used internally in cpp file as the observation</span></span>
<span>    <span class="co"># vector for all observation (log biomass + cpue) in the likelihood</span></span>
<span>    <span class="co"># functions (and required for OSA residuals). note the transpose t() needed</span></span>
<span>    <span class="co"># to get these matrices in the correct order (by row instead of by col) --</span></span>
<span>    <span class="co"># note obsvec is masked from users normally in prepare_rema_input()</span></span>
<span>    <span class="va">newinput</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">obsvec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">log_biomass_obs</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">log_biomass_obs</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">cpue</span><span class="op">)</span> <span class="op">{</span><span class="va">newinput</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">obsvec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">log_biomass_obs</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">log_biomass_obs</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">log_cpue_obs</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">log_cpue_obs</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">}</span></span>
<span></span>
<span>    <span class="co"># refit model</span></span>
<span>    <span class="va">mod_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_rema.html">fit_rema</a></span><span class="op">(</span><span class="va">newinput</span>, do.sdrep <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># add parameter estimates to matrix</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">mod_new</span><span class="op">$</span><span class="va">opt</span><span class="op">$</span><span class="va">convergence</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">re_est</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mod_new</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mod_name</span><span class="op">$</span><span class="va">par</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">re_est</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mod_name</span><span class="op">$</span><span class="va">par</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">re_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">re_est</span><span class="op">)</span>; <span class="va">re_est</span><span class="op">$</span><span class="va">type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"recovered"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">re_est</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Run self-test for AI Pcod and GOA Thornyhead and examine results:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># run for pcod and prep data frame</span></span>
<span><span class="co"># run simulation testing</span></span>
<span><span class="va">par_ests</span> <span class="op">&lt;-</span> <span class="fu">sim_test</span><span class="op">(</span>mod_name <span class="op">=</span> <span class="va">pcod_mod</span>, replicates <span class="op">=</span> <span class="fl">500</span>, cpue <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># get data frame with simulation values for each parameter</span></span>
<span><span class="va">n_not_converged_pcod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">par_ests</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>; <span class="va">n_pcod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">par_ests</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">prop_converged_pcod</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">-</span><span class="va">n_not_converged_pcod</span><span class="op">/</span><span class="va">n_pcod</span></span>
<span></span>
<span><span class="va">mod_par_ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"log_PE1"</span> <span class="op">=</span> <span class="va">pcod_mod</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                           type <span class="op">=</span> <span class="st">"model"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par_ests</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mod_par_ests</span><span class="op">)</span> <span class="co"># rename for ease</span></span>
<span><span class="va">pcod_par_ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">mod_par_ests</span>, <span class="va">par_ests</span><span class="op">)</span> <span class="co"># recovered and model in one data frame</span></span>
<span><span class="va">pcod_par_ests</span><span class="op">$</span><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"AI Pcod"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># run for thorny and prep data frame -- same process</span></span>
<span><span class="co"># run simulation testing</span></span>
<span><span class="va">par_ests</span> <span class="op">&lt;-</span> <span class="fu">sim_test</span><span class="op">(</span>mod_name <span class="op">=</span> <span class="va">thrn_mod</span>, replicates <span class="op">=</span> <span class="fl">500</span>, cpue <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># note some warnings</span></span>
<span><span class="co"># sometimes spits out: In stats::nlminb(model$par, model$fn, model$gr, control =</span></span>
<span><span class="co"># list(iter.max = 1000,...: NA/NaN function evaluation</span></span>
<span><span class="va">n_not_converged_thrn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">par_ests</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>; <span class="va">n_thrn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">par_ests</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">prop_converged_thrn</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">-</span><span class="va">n_not_converged_thrn</span><span class="op">/</span><span class="va">n_thrn</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">par_ests</span><span class="op">)</span></span>
<span><span class="co"># get data frame with simulation values for each parameter</span></span>
<span><span class="va">mod_par_ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"log_PE1"</span> <span class="op">=</span> <span class="va">thrn_mod</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                           <span class="st">"log_PE2"</span> <span class="op">=</span> <span class="va">thrn_mod</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>                           <span class="st">"log_PE3"</span> <span class="op">=</span> <span class="va">thrn_mod</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>                           <span class="st">"log_q"</span> <span class="op">=</span> <span class="va">thrn_mod</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,</span>
<span>                           <span class="st">"log_tau_biomass"</span> <span class="op">=</span> <span class="va">thrn_mod</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>,</span>
<span>                           <span class="st">"log_tau_cpue"</span> <span class="op">=</span> <span class="va">thrn_mod</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span>,</span>
<span>                           type <span class="op">=</span> <span class="st">"model"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par_ests</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mod_par_ests</span><span class="op">)</span> <span class="co"># rename for ease</span></span>
<span><span class="va">thrn_par_ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">mod_par_ests</span>, <span class="va">par_ests</span><span class="op">)</span> <span class="co"># recovered and model parameters in one data frame</span></span>
<span><span class="va">thrn_par_ests</span><span class="op">$</span><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"GOA Thornyhead"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># reogranize data</span></span>
<span><span class="va">pcod_sim</span> <span class="op">&lt;-</span> <span class="va">pcod_par_ests</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">pivot_longer</span><span class="op">(</span><span class="fl">1</span>, names_to <span class="op">=</span> <span class="st">"parameter"</span><span class="op">)</span></span>
<span><span class="va">thrn_sim</span> <span class="op">&lt;-</span> <span class="va">thrn_par_ests</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">pivot_longer</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, names_to <span class="op">=</span> <span class="st">"parameter"</span><span class="op">)</span></span>
<span><span class="va">sim_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">pcod_sim</span>, <span class="va">thrn_sim</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Relative Error: ((om-em)/om)</span></span>
<span><span class="va">sim_re</span> <span class="op">&lt;-</span> <span class="va">sim_dat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sp"</span>, <span class="st">"parameter"</span><span class="op">)</span>,</span>
<span>              names_from <span class="op">=</span> <span class="va">type</span>, values_from <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">recovered</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>RE <span class="op">=</span> <span class="op">(</span><span class="va">model</span><span class="op">-</span><span class="va">recovered</span><span class="op">)</span><span class="op">/</span><span class="va">model</span><span class="op">*</span><span class="fl">100</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">sp</span>, <span class="va">parameter</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Median RE="</span>, <span class="fu"><a href="https://rdrr.io/r/base/formatc.html" class="external-link">formatC</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">RE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, format <span class="op">=</span> <span class="st">"f"</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="st">"%"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot distribution of simulated parameter estimates</span></span>
<span><span class="va">plot_sim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim_dat</span>, <span class="va">plot_title</span>, <span class="va">fill_col</span> <span class="op">=</span> <span class="st">"#21918c"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># add distribution of recovered parameters</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html" class="external-link">geom_violin</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim_dat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"recovered"</span><span class="op">)</span>,</span>
<span>                fill <span class="op">=</span> <span class="va">fill_col</span>, alpha <span class="op">=</span> <span class="fl">0.6</span>, draw_quantiles <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># add "true values" from original model</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim_dat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"model"</span><span class="op">)</span>,</span>
<span>               size <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">parameter</span>, scales <span class="op">=</span> <span class="st">"free"</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"Parameter estimate"</span>, title <span class="op">=</span> <span class="va">plot_title</span>,</span>
<span>         subtitle <span class="op">=</span> <span class="st">"Distribution of parameters estimates (median=horizontal line, true value=point)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_x_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="cn">NULL</span>, breaks <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># plot relative error</span></span>
<span><span class="va">plot_re</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim_re</span>, <span class="va">fill_col</span> <span class="op">=</span> <span class="st">"#21918c"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="va">RE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># add distribution of recovered parameters</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim_re</span>, alpha <span class="op">=</span> <span class="fl">0.6</span>, fill <span class="op">=</span> <span class="va">fill_col</span>,</span>
<span>                 na.rm <span class="op">=</span> <span class="cn">TRUE</span>, outlier.size <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># separate by parameter</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">parameter</span><span class="op">+</span><span class="va">label</span>, scales <span class="op">=</span> <span class="st">"free"</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="co">#, space = "free") +</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"Relative error (%)"</span>, subtitle <span class="op">=</span> <span class="st">"Distribution of relative error (RE; i.e., (true-estimated values)/true value*100)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_x_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="cn">NULL</span>, breaks <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">p1pcod</span> <span class="op">&lt;-</span> <span class="fu">plot_sim</span><span class="op">(</span><span class="va">pcod_sim</span>, <span class="st">"AI Pcod Simulation"</span>, fill_col <span class="op">=</span> <span class="st">"goldenrod"</span><span class="op">)</span></span>
<span><span class="va">p1thrn</span> <span class="op">&lt;-</span> <span class="fu">plot_sim</span><span class="op">(</span><span class="va">thrn_sim</span>, <span class="st">"GOA Thornyhead Simulation"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2pcod</span> <span class="op">&lt;-</span> <span class="fu">plot_re</span><span class="op">(</span><span class="va">sim_re</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sp</span> <span class="op">==</span> <span class="st">"AI Pcod"</span><span class="op">)</span>, fill_col <span class="op">=</span> <span class="st">"goldenrod"</span><span class="op">)</span></span>
<span><span class="va">p2thrn</span> <span class="op">&lt;-</span> <span class="fu">plot_re</span><span class="op">(</span><span class="va">sim_re</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sp</span> <span class="op">==</span> <span class="st">"GOA Thornyhead"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1pcod</span>, <span class="va">p2pcod</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"vignettes/ex4_sim_pcod.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">6.5</span>, height <span class="op">=</span> <span class="fl">7</span>, units <span class="op">=</span> <span class="st">"in"</span>, bg <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1thrn</span>, <span class="va">p2thrn</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"vignettes/ex4_sim_thrn.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">11</span>, height <span class="op">=</span> <span class="fl">7</span>, units <span class="op">=</span> <span class="st">"in"</span>, bg <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span></code></pre></div>
<p><strong>Results of the simulation self-test</strong></p>
<p>Only 1 out of 500 simulation replicates did not converge for the AI
Pcod model, which suggests a high degree of model stability. There were
11 out 500 simulation replicates for the GOA Thornyhead model that did
not converge. In Figure 2 the top row within each panel shows the
distribution of resulting recovered parameter estimates in each of the
models based on the simulations, where the horizontal line is the median
estimated value and the black dot is the true value (i.e., the
parameters estimates from the real data sets). </p>
<p>As demonstrated in the boxplots of the bottom rows of Figure 2, the
parameters in both models are recovered well in simulation testing, with
low median relative error. In both models there are instances of long
negative tails in the log standard deviation of the process error
(<code>log_PE</code>; Figure 2 top row within each panel), suggesting
that PE was small or tended towards zero in some simulations (recall
that parameters are estimated in log space, and a very negative number
in log space is close to zero in natural space). This is also the case
for the extra observation error for the biomass survey
(<code>log_tau_biomass</code>) in the GOA Thornyhead model (Figure 2,
top row within lower panel). </p>
<p>These outlier replicates, which occur when the optimizer used by
<code>rema</code> (<code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb()</a></code>) returns a
<code>“NA/NaN function evaluation”</code> error, help shed light on why
some replicates failed to converge. Under the hood, the optimizer is
pushing the PE towards zero (PE=0 is the same as taking a global mean of
the biomass time series), violating the central assumption of the REMA
model that the biomass has an underlying trend (PE &gt; 0, and thus PE
can be log-transformed). The negative log-scale values are most extreme
for the GOA Thornyhead model, which should raise some concern of
potential model misspecification or over-parameterization. For example,
given the trade-off between process and observation error in REMA (where
including an additional observation dampens the biomass trend estimated,
pushing PE towards zero), it is possible that the estimation of
additional observation error on the biomass survey
(<code>log_tau_biomass</code>) might not be justified.</p>
<p><img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_sim.png" style="width:10in"><em>Figure 2.</em> <em>Simulation self-test results
for AI Pcod (top panels; gold) and GOA Thornyhead (bottom panels; teal).
The upper row of each panel gives the distribution of the recovered
parameters, with the dot giving the “true value” used to simulate the
data. The lower row of each panel gives the relative error of the
recovered parameters, with the zero line indicating the simulation
returns the “true value,” the box plot line giving the median of the
recovered parameter’s relative errors, and the whiskers and dots of the
boxplots giving the spread of the recovered parameter’s relative
errors.</em></p>
</div>
<div class="section level3">
<h3 id="residual-analysis">2. Residual analysis<a class="anchor" aria-label="anchor" href="#residual-analysis"></a>
</h3>
<p>Residuals are used to test the underlying assumptions about the
structure and error distributions in the model. For example, in a linear
regression, residuals should be independent, normal, and have constant
variance. Traditional residuals (e.g., Pearson’s residuals) are
inappropriate for state-space models like REMA, because the random
effects induce correlations in the predicted data such that the
residuals are no longer independent. Additionally, process error
variance may be overestimated in cases where the model is mis-specified,
thus leading to artificially small residuals (see Section 3 of Thygesen
et al. 2017 for an example). The appropriate residual type for
validation of state-space models are one-step ahead (OSA) residuals.
Instead of comparing the observed and expected values at the same time
step, OSA residuals use forecasted values based on all previous
observations (i.e., they exclude the observed value at the current time
step from prediction). In this way, OSA residuals account for
non-normality and correlation in the residuals among years. </p>
<p>Under a correctly specified model, resultant OSA residuals should be
independent and identically distributed (i.i.d.) with a standard normal
distribution
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">N(0,1)</annotation></semantics></math>.
This can be tested with a normal QQ plot, where the theoretical quantile
values of the standard normal distribution are plotted on the
<em>x</em>-axis, and the corresponding empirical quantile values of the
OSA residuals are plotted on the <em>y</em>-axis. If the OSA residuals
are standard normally distributed, the points will fall on the 0/1
reference line, and the standard deviation of normalized residuals
(SDNR) statistic will be close to 1. If the residuals are not standard
normally distributed (SDNR far from 1), the points will deviate from the
reference line. In the case where the model includes multiple strata and
surveys, OSA residuals should be normally distributed within and across
strata and surveys, however small sample sizes (e.g., within a single
stratum) may not have sufficient statistical power to identify model
misfit. </p>
<p>In addition to the normality of OSA residuals, residuals should be
random and independent (i.e., they should not be correlated by year).
Standard approaches such as autocorrelation function (ACF) plots or
residual runs tests (e.g., Wald-Wolfowitz test) are inappropriate for
many REMA applications because of missing years of data in the survey
time series, and instead, we directly plot the residuals against the
years of the survey time series. Visual patterns or extreme outliers
(greater than 3 or less than -3 for N(0,1) distribution) in the
residuals can indicate structure in the data (i.e., temporal
correlation) that is not adequately captured by the model. </p>
<p>Methods for calculating OSA residuals in REMA have been implemented
in the <code><a href="../reference/get_osa_residuals.html">rema::get_osa_residuals()</a></code> using the
<code><a href="https://rdrr.io/pkg/TMB/man/oneStepPredict.html" class="external-link">TMB::oneStepPredict()</a></code> function and the fullGaussian method
when using lognormal error distributions. The
<code><a href="../reference/get_osa_residuals.html">rema::get_osa_residuals()</a></code> returns tidied dataframes of
observations, REMA model predictions, and OSA residuals for the biomass
and CPUE survey data when appropriate, along with QQ and residual-time
series diagnostic plots. </p>
<p><strong>Results of the residual analysis</strong></p>
<p>The normal QQ plot for AI Pcod (Figure 3, top panel) suggests slight
negative skewness in the residuals (i.e., the majority of the points
fall below the 0/1 line), though the small sample size makes
interpretation challenging. The SDNR is 0.99 (recall a perfect model
would have an SDNR=1.00), indicating  assumptions are likely met for the
residuals. The plot of OSA residuals by year (Figure 3, bottom panel)
shows no obvious patterns in the residuals, suggesting they are
independent; there is no evidence of outliers in the residuals that
warrant further inspection.</p>
<p>The combined normal QQ plot for GOA Thornyhead OSA residuals (Figure
4, top panel) suggests they follow a normal distribution (the points
fall along the 0/1 line), though there is evidence of slight positive,
or right skewness (the majority of the points fall above the 0/1 line).
The SDNR is approximately 1, indicating the variance assumptions are
likely met for the residuals. The QQ plots for the biomass by strata
(Figure 4, middle panels) highlight where some of the positive skewness
may be coming from (e.g., EGOA 701-1000m, WGOA 0-500 m); however, small
sample sizes by stratum make interpretation of these QQ plots difficult.
The QQ plots for the CPUE by strata (Figure 4, bottom panel) are mostly
normal, though there is some evidence of light tails in the WGOA
stratum.</p>
<p>The plot of OSA residuals by year for the GOA Thornyhead OSA
residuals by biomass strata (Figure 5, top panels) show no patterns in
the residuals, suggesting they are independent. However, there are runs
in the residuals for the CPUE strata (Figure 5, bottom panels),
especially in the CGOA and WGOA, which might indicate model
misspecification or misfit. There is no evidence of outliers.</p>
<p><img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_aipcod_osa.png" style="width:5in"><em>Figure 3. One-step ahead (OSA) residual plots
for AI Pcod. The top panel gives the QQ plot, comparing the normal
distribution quantiles (x-axis) to the OSA residual distribution
quantiles (y-axis). The diagonal line is the 0-1 line, where the two
quantiles are equal, and the SDNR statistic is given in the upper left
of the plot. The bottom panel gives the residuals (y-axis) plotted by
year (x-axis) which is used to check for independence.</em></p>
<p><img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_thrn_osaqq.png" style="width:10in"><em>Figure 4.</em> <em>One-step ahead (OSA) QQ
plots across (top panel) and within strata (middle panel, bottom trawl
survey strata; and bottom panel, longline survey strata) for GOA
Thornyhead. In both panels, the colors correspond to bottom trawl survey
strata. The SDNR statistic is given for the across strata QQ plot; the
within strata plots are useful to check for extreme skew but lack
statistical power.</em></p>
<p><em><img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_thrn_osa.png" style="width:10in"> Figure 5. One-step ahead (OSA) residual plots for
GOA Thornyhead. The residuals (y-axis) for each annual time step (random
effect; x-axis) for each survey stratum.</em></p>
</div>
<div class="section level3">
<h3 id="laplace-approximation-are-the-model-assumptions-related-to-random-effects-estimation-reasonable">3. Laplace approximation: Are the model assumptions related to
random effects estimation reasonable?<a class="anchor" aria-label="anchor" href="#laplace-approximation-are-the-model-assumptions-related-to-random-effects-estimation-reasonable"></a>
</h3>
<p>The <code>rema</code> library was developed in Template Model Builder
(<code>TMB</code>), which uses maximum marginal likelihood estimation
with the Laplace approximation to efficiently estimate high dimensional,
non-linear mixed effects models in a frequentist framework (Skaug and
Fournier, 2006; Kristensen et al., 2016). The primary assumption in
models using the Laplace approximation is that the random effects follow
a normal distribution. This assumption simplifies the complex integrals
that make up the likelihood function. The Laplace approximation is fast
and accurate when the normality assumption is met; however, if the true
distribution of the random effects is not normal, the Laplace
approximation may introduce bias into the parameter estimates.</p>
<p>We can test the validity of the Laplace approximation using Markov
chain Monte Carlo (MCMC) sampling in the <code>tmbstan</code> library,
comparing the distributions of the fixed effects parameters from
MCMC-sampled models with and without the Laplace approximation (Monnahan
and Kristensen, 2018). To do so, we compare the distributions using QQ
plots between the two model cases. The Laplace approximation is
reasonably accurate if the sampling quantiles for the two models (with
and without the Laplace approximation) are similar, i.e., they fall on
the 1:1 line. This can also help us identify bias introduced by the
Laplace approximation, for example, if the fixed effects estimates and
their associated estimates of uncertainty differ between the base model
(run with marginal maximum likelihood estimation using the Laplace
approximation) and the MCMC versions with and without the Laplace
approximation. MCMC models were run with 1000 iterations, assuming a
warmup of 500. As discussed in the Results section, iterations were
increased to 5000 with a warmup of 2500 for GOA Thornyhead in an effort
to improve diagnostics and model convergence.</p>
<p>The function below is used to run the two model cases:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># function to (1) run models with and without laplace approximation for</span></span>
<span><span class="co"># comparison and (2) return posterior data frames and models</span></span>
<span><span class="co"># function input: model (e.g., AI Pcod or GOA Thornyhead), number of iterations</span></span>
<span><span class="co"># (samples), number of chains</span></span>
<span><span class="va">mcmc_comp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mod_name</span>, <span class="va">it_numb</span>, <span class="va">chain_numb</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># set up MCMC chain information</span></span>
<span>  <span class="va">it_num</span> <span class="op">&lt;-</span> <span class="va">it_numb</span></span>
<span>  <span class="va">chain_num</span> <span class="op">&lt;-</span> <span class="va">chain_numb</span></span>
<span>  <span class="co"># mod_name = pcod_mod; it_num = 1000; chain_num = 4</span></span>
<span></span>
<span>  <span class="co"># run model with laplace approximation</span></span>
<span>  <span class="va">mod_la</span> <span class="op">&lt;-</span> <span class="fu">tmbstan</span><span class="op">(</span>obj <span class="op">=</span> <span class="va">mod_name</span>, chains <span class="op">=</span> <span class="va">chain_num</span>, init <span class="op">=</span> <span class="va">mod_name</span><span class="op">$</span><span class="va">par</span>, laplace <span class="op">=</span> <span class="cn">TRUE</span>, iter <span class="op">=</span> <span class="va">it_num</span><span class="op">)</span></span>
<span>  <span class="co"># run model without laplace approximation, i.e., all parameters fully estimated without assumptions of normality</span></span>
<span>  <span class="va">mod_mcmc</span> <span class="op">&lt;-</span> <span class="fu">tmbstan</span><span class="op">(</span>obj <span class="op">=</span> <span class="va">mod_name</span>, chains <span class="op">=</span> <span class="va">chain_num</span>, init <span class="op">=</span> <span class="va">mod_name</span><span class="op">$</span><span class="va">par</span>, laplace <span class="op">=</span> <span class="cn">FALSE</span>, iter <span class="op">=</span> <span class="va">it_num</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># posteriors as data frame</span></span>
<span>  <span class="va">post_la</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">mod_la</span><span class="op">)</span>; <span class="va">post_la</span><span class="op">$</span><span class="va">type</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="st">"la"</span><span class="op">)</span></span>
<span>  <span class="va">post_mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">mod_mcmc</span><span class="op">)</span>; <span class="va">post_mcmc</span> <span class="op">&lt;-</span> <span class="va">post_mcmc</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mod_name</span><span class="op">$</span><span class="va">par</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">post_mcmc</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">]</span>; <span class="va">post_mcmc</span><span class="op">$</span><span class="va">type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"mcmc"</span><span class="op">)</span></span>
<span>  <span class="co"># informational things... this is for getting the posterior draws, i.e., to</span></span>
<span>  <span class="co"># test traceplots and such</span></span>
<span>  <span class="va">post_la</span><span class="op">$</span><span class="va">chain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">chain_num</span>, each <span class="op">=</span> <span class="va">it_num</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">post_la</span><span class="op">$</span><span class="va">iter_num</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">it_num</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="va">chain_num</span><span class="op">)</span></span>
<span>  <span class="va">post_mcmc</span><span class="op">$</span><span class="va">chain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">chain_num</span>, each <span class="op">=</span> <span class="va">it_num</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">post_mcmc</span><span class="op">$</span><span class="va">iter_num</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">it_num</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="va">chain_num</span><span class="op">)</span></span>
<span>  <span class="va">post_draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">post_la</span>, <span class="va">post_mcmc</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># get quantiles</span></span>
<span>  <span class="va">qv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>  <span class="va">quant_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>quant <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                          la <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                          mcmc <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                          par <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">post_la</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co"># post_la has type, chains, lp, iteration number column that don"t count</span></span>
<span></span>
<span>    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>quant <span class="op">=</span> <span class="va">qv</span>,</span>
<span>                      la <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">post_la</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, probs <span class="op">=</span> <span class="va">qv</span><span class="op">)</span>,</span>
<span>                      mcmc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">post_mcmc</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, probs <span class="op">=</span> <span class="va">qv</span><span class="op">)</span>,</span>
<span>                      par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"V"</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">quant_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">quant_dat</span>, <span class="va">tmp</span><span class="op">)</span></span>
<span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">quant_dat</span>, <span class="va">post_draws</span>, <span class="va">mod_la</span>, <span class="va">mod_mcmc</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># run models</span></span>
<span><span class="va">pcod_comp</span> <span class="op">&lt;-</span> <span class="fu">mcmc_comp</span><span class="op">(</span>mod_name <span class="op">=</span> <span class="va">pcod_mod</span>, it_numb <span class="op">=</span> <span class="fl">1000</span>, chain_numb <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">thrn_comp_log_tau</span> <span class="op">&lt;-</span> <span class="fu">mcmc_comp</span><span class="op">(</span>mod_name <span class="op">=</span> <span class="va">thrn_mod</span>, it_numb <span class="op">=</span> <span class="fl">5000</span>, chain_numb <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> </span></code></pre></div>
<p>The following code uses the output from <code>mcmc_comp()</code> to
make a QQ plot to compare the posterior distributions of the parameters
and parameter estimates between the MCMC models with and without the
Laplace approximation:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># clean up data frame names by renaming things</span></span>
<span><span class="va">pcod_qq</span> <span class="op">&lt;-</span> <span class="va">pcod_comp</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">pcod_qq</span><span class="op">$</span><span class="va">par_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"log_PE1"</span><span class="op">)</span>; <span class="va">pcod_qq</span><span class="op">$</span><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"AI Pcod"</span><span class="op">)</span></span>
<span><span class="va">thrn_qq</span> <span class="op">&lt;-</span> <span class="va">thrn_comp_log_tau</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">thrn_qq</span><span class="op">$</span><span class="va">par_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">recode</a></span><span class="op">(</span><span class="va">thrn_qq</span><span class="op">$</span><span class="va">par</span>,</span>
<span>                           V1 <span class="op">=</span> <span class="st">"log_PE1"</span>,</span>
<span>                           V2 <span class="op">=</span> <span class="st">"log_PE2"</span>,</span>
<span>                           V3 <span class="op">=</span> <span class="st">"log_PE3"</span>,</span>
<span>                           V4 <span class="op">=</span> <span class="st">"log_q"</span>,</span>
<span>                           V5 <span class="op">=</span> <span class="st">"log_tau_biomass"</span>,</span>
<span>                           V6 <span class="op">=</span> <span class="st">"log_tau_cpue"</span><span class="op">)</span></span>
<span><span class="va">thrn_qq</span><span class="op">$</span><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"GOA Thornyhead"</span><span class="op">)</span></span>
<span><span class="va">qq_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">pcod_qq</span>, <span class="va">thrn_qq</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot</span></span>
<span><span class="va">plot_laplace_mcmc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">qq_dat</span>, <span class="va">plot_title</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">qq_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">mcmc</span>, <span class="va">la</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"lightgray"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">par_name</span>, scales <span class="op">=</span> <span class="st">"free"</span>, nrow <span class="op">=</span> <span class="fl">2</span>,  dir <span class="op">=</span> <span class="st">"v"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"MCMC"</span>, y <span class="op">=</span> <span class="st">"Laplace approx."</span>, title <span class="op">=</span> <span class="va">plot_title</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>          axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>          axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>          strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">plot_laplace_mcmc</span><span class="op">(</span><span class="va">pcod_qq</span>, <span class="st">"AI Pcod"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">plot_laplace_mcmc</span><span class="op">(</span><span class="va">thrn_qq</span>, <span class="st">"GOA Thornyhead"</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, rel_widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>,<span class="fl">0.6</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"vignettes/ex4_mcmc_qq.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">11</span>, height <span class="op">=</span> <span class="fl">7</span>, units <span class="op">=</span> <span class="st">"in"</span>, bg <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># parameter summary table - compare the marginal max likelihood estimates (MMLE)</span></span>
<span><span class="co"># with the mcmc estimates. Rhat is the potential scale reduction factor on split</span></span>
<span><span class="co"># chains (at convergence, Rhat=1)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">pcod_comp</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">summary</span><span class="op">[</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>,<span class="fl">4</span>,<span class="fl">8</span>,<span class="fl">10</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span><span class="va">psum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Stock <span class="op">=</span> <span class="st">'AI Pcod'</span>, Model <span class="op">=</span> <span class="st">'MCMC_Laplace'</span>, FixedEffect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>, <span class="va">m</span>, row.names <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">pcod_comp</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">summary</span><span class="op">[</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>,<span class="fl">4</span>,<span class="fl">8</span>,<span class="fl">10</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span><span class="va">psum</span> <span class="op">&lt;-</span> <span class="va">psum</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Stock <span class="op">=</span> <span class="st">'AI Pcod'</span>, Model <span class="op">=</span> <span class="st">'MCMC_withoutLaplace'</span>, FixedEffect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>, <span class="va">m</span>, row.names <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">thrn_comp_log_tau</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">summary</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>,<span class="fl">4</span>,<span class="fl">8</span>,<span class="fl">10</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span><span class="va">psum</span> <span class="op">&lt;-</span> <span class="va">psum</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Stock <span class="op">=</span> <span class="st">'GOA Thornyhead'</span>, Model <span class="op">=</span> <span class="st">'MCMC_Laplace'</span>, FixedEffect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>, <span class="va">m</span>, row.names <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">thrn_comp_log_tau</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">summary</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>,<span class="fl">4</span>,<span class="fl">8</span>,<span class="fl">10</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span><span class="va">psum</span> <span class="op">&lt;-</span> <span class="va">psum</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Stock <span class="op">=</span> <span class="st">'GOA Thornyhead'</span>, Model <span class="op">=</span> <span class="st">'MCMC_withoutLaplace'</span>, FixedEffect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>, <span class="va">m</span>, row.names <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">pcod_mod</span><span class="op">$</span><span class="va">sdrep</span>, <span class="st">"Est"</span><span class="op">)</span><span class="op">$</span><span class="va">log_PE</span></span>
<span><span class="va">sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">pcod_mod</span><span class="op">$</span><span class="va">sdrep</span>, <span class="st">"Std"</span><span class="op">)</span><span class="op">$</span><span class="va">log_PE</span></span>
<span><span class="va">psum</span> <span class="op">&lt;-</span> <span class="va">psum</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Stock <span class="op">=</span> <span class="st">'AI Pcod'</span>, Model <span class="op">=</span> <span class="st">'Base_MMLE_Laplace'</span>, FixedEffect <span class="op">=</span> <span class="st">"log_PE"</span>,</span>
<span>                                      X50. <span class="op">=</span> <span class="va">pars</span>, X2.5. <span class="op">=</span> <span class="va">pars</span><span class="op">-</span><span class="fl">1.96</span><span class="op">*</span><span class="va">sd</span>, X97.5. <span class="op">=</span> <span class="va">pars</span><span class="op">+</span><span class="fl">1.96</span><span class="op">*</span><span class="va">sd</span>, Rhat <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">thrn_mod</span><span class="op">$</span><span class="va">sdrep</span>, <span class="st">"Est"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"log_PE|log_q|log_tau"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">thrn_mod</span><span class="op">$</span><span class="va">sdrep</span>, <span class="st">"Std"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sd</span> <span class="op">&lt;-</span> <span class="va">sd</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sd</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"log_PE|log_q|log_tau"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sd</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">psum</span> <span class="op">&lt;-</span> <span class="va">psum</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Stock <span class="op">=</span> <span class="st">'GOA Thornyhead'</span>, Model <span class="op">=</span> <span class="st">'Base_MMLE_Laplace'</span>, FixedEffect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">thrn_comp_log_tau</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">summary</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>,,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                                      X50. <span class="op">=</span> <span class="va">pars</span>, sd <span class="op">=</span> <span class="va">sd</span>, row.names <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>                             <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>X2.5. <span class="op">=</span> <span class="va">X50.</span><span class="op">-</span><span class="fl">1.96</span><span class="op">*</span><span class="va">sd</span>,</span>
<span>                                    X97.5. <span class="op">=</span> <span class="va">X50.</span><span class="op">+</span><span class="fl">1.96</span><span class="op">*</span><span class="va">sd</span>,</span>
<span>                                    Rhat <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>                             <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">sd</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># write.csv(psum, 'vignettes/ex4_param_table.csv')</span></span></code></pre></div>
<p><strong>Results for testing the validity of the Laplace
approximation</strong></p>
<p>Figure 6 gives the compared quantiles from full MCMC testing (x-axis)
and the Laplace approximation (y-axis) for AI Pcod and GOA Thornyhead
models.</p>
<p>For the simpler AI Pcod model (Figure 6, left panel), the Laplace
approximation and full MCMC testing show a similar distribution,
indicating that the Laplace approximation is reasonable. Additionally
the estimates of fixed effects are nearly identical between the base
model and MCMC models with and without the Laplace approximation (Table
1).</p>
<p>For the more complex GOA Thornyhead model, the preliminary model
results based on 1000 iterations exhibited poor diagnostics for all
process error parameters and the additional observation error for the
biomass survey (<code>log_tau_biomass</code>). We increased the number
of MCMC iterations to 5000 in an effort to improve convergence
diagnostics; however, the log_tau_biomass parameter continued to show
significant deviations between the models with and without the Laplace
approximation (Figure 6, right panels). A comparison of the fixed
effects estimates between the base models show large differences in the
parameter estimates and their associated estimates of uncertainty (Table
1). This indicates that the Laplace approximation is likely inaccurate,
and that further investigation into model structure might be
necessary.</p>
<p><em>Table 1. AI Pcod and GOA Thornyhead fixed effect estimates with
95% confidence or credible intervals for maximum likelihood or MCMC
models, respectively (CI). Fixed effects estimates are compared between
the base model run with marginal maximum likelihood estimation assuming
the Laplace approximation (“Base_MMLE_Laplace”) and MCMC models with and
without the Laplace approximation (“MCMC_Laplace” and
“MCMC_withoutLaplace”, respectively). The Rhat statistic is provided for
MCMC models and is a convergence metric (convergence = Rhat = 1).
Nonconverged parameters are highlighted in bold. The parameter estimate
for the MCMC models is the median of the posterior samples.</em></p>
<p><img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_param_table.PNG" style="width:6in"></p>
<p><img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_mcmc_qq.png" style="width:10in"></p>
<p><em>Figure 6. Results from Laplace approximation testing. We compare
the results of running a model without assuming normality of random
effects (MCMC, x-axis) and running a model assuming normality of random
effects (Laplace approximation, y-axis), where the quantiles of each are
plotted against each other for each fixed effect in the model. The gray
line is the 1:1 line; points that fall on the gray line indicate that
the quantile value is the same between the two cases. The top panel
gives the plot for the AI Pcod model (one fixed effect), and the bottom
panels give the plots for the GOA Thornyhead model (six fixed
effects).</em></p>
</div>
<div class="section level3">
<h3 id="parameter-correlation-are-the-model-parameters-identifiable-and-non-redundant">4. Parameter correlation: Are the model parameters identifiable and
non-redundant?<a class="anchor" aria-label="anchor" href="#parameter-correlation-are-the-model-parameters-identifiable-and-non-redundant"></a>
</h3>
<p>Parameter redundancy refers to the idea that multiple parameters
contribute to the model in the same way. An intuitive case is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>∼</mo><msub><mi>β</mi><mn>1</mn></msub><mo>+</mo><msub><mi>β</mi><mn>2</mn></msub><mo>+</mo><mi>α</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">y \sim \beta_1 + \beta_2 + \alpha x</annotation></semantics></math>,
since the model could estimate many combinations of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mn>1</mn></msub><annotation encoding="application/x-tex">\beta_1</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mn>2</mn></msub><annotation encoding="application/x-tex">\beta_2</annotation></semantics></math>
which minimize the log-likelihood, i.e., the sampled parameters will be
correlated. To reduce redundancy,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>β</mi><mn>1</mn></msub><mo>+</mo><msub><mi>β</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\beta_1 + \beta_2</annotation></semantics></math>
can be redefined as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mn>0</mn></msub><annotation encoding="application/x-tex">\beta_0</annotation></semantics></math>.</p>
<div class="section level4">
<h4 id="results-of-parameter-correlation-analysis">
<strong>Results of parameter correlation analysis</strong><a class="anchor" aria-label="anchor" href="#results-of-parameter-correlation-analysis"></a>
</h4>
<p>Figure 7 shows a pairwise correlation matrix of the posterior draws
for the GOA Thornyhead model (the MCMC model with the Laplace
approximation), with histograms of the univariate marginal distributions
on the diagonal and a scatterplot of the bivariate distributions off the
diagonal. There are significant unresolved sampling problems of the
log_tau_biomass parameter, shown by the non-normal and heavily skewed
distribution of log_tau_biomass. The pairwise scatterplots on the
off-diagonals show that the heavy left tails in log_tau_biomass are
causing interactions (i.e., correlation) with almost all other
parameters in the model. This diagnostic is a clear indication that
there is model mis-specification that warrants further
investigation.</p>
<p><img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_pairs_thrn.png" style="width:10in"></p>
<p><em>Figure 7. Pairs plot for the GOA Thornyhead MCMC model assuming
the Laplace approximation. The diagonal plots give the distribution of
each fixed effect for 2500 MCMC draws. The off-diagonal elements give
the parameter-by-parameter correlation, where each point gives the
parameter values estimated from the same MCMC simulation.</em></p>
</div>
</div>
<div class="section level3">
<h3 id="is-the-goa-thornyhead-model-really-converged">5. Is the GOA Thornyhead model really converged?<a class="anchor" aria-label="anchor" href="#is-the-goa-thornyhead-model-really-converged"></a>
</h3>
<p>Despite the poor diagnostics shown in this vignette for the GOA
Thornyhead model, the standard output in <code>TMB</code> and
<code>rema</code> suggests that this model is converged (i.e., it has a
low maximum gradient component and the standard error estimates appear
reasonable). Within the MCMC framework, we can look at the mixing of
MCMC across multiple chains using a diagnostic called a traceplot to
assess convergence. The following code shows how to do that within the
<code>rstan</code> library (Stan Development Team, 2024):</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1_mcmc_pcod</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html" class="external-link">traceplot</a></span><span class="op">(</span><span class="va">pcod_comp</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Traceplots to assess mixing across Markov chains and convergence"</span>, subtitle <span class="op">=</span> <span class="st">"AI Pcod"</span><span class="op">)</span></span>
<span><span class="va">p1_mcmc_thrn</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html" class="external-link">traceplot</a></span><span class="op">(</span><span class="va">thrn_comp_log_tau</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span>label <span class="op">=</span> <span class="cn">NULL</span>, subtitle <span class="op">=</span> <span class="st">"GOA Thornyhead"</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1_mcmc_pcod</span>, <span class="va">p1_mcmc_thrn</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"vignettes/ex4_traceplots.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">11</span>, height <span class="op">=</span> <span class="fl">8</span>, units <span class="op">=</span> <span class="st">"in"</span>, bg <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span></code></pre></div>
<p>From the traceplots for both models in the figures below, we see that
the AI Pcod model MCMC chains are fully mixed and the model is converged
(top panel). However, for the GOA Thornyhead model (bottom panel), we
see that the estimation of additional observation error
(log_tau_biomass) is causing convergence issues and the MCMC chains are
not well mixed.</p>
<p><img src="https://raw.githubusercontent.com/afsc-assessments/rema/master/vignettes/ex4_traceplots.png" style="width:10in"></p>
<p><em>Figure 8.  MCMC traceplots for AI Pcod (top panel) and GOA
Thornyhead (bottom panels). Each subpanel is an individual parameter,
and the plot gives the value of the parameter (y-axis) for each
simulation draw (x-axis) for each model chain (color).</em></p>
</div>
<div class="section level3">
<h3 id="when-should-we-care-about-failed-model-diagnostics">
<strong>When should we care about failed model
diagnostics?</strong><a class="anchor" aria-label="anchor" href="#when-should-we-care-about-failed-model-diagnostics"></a>
</h3>
<p>The REMA model is used within the NPFMC to obtain exploitable biomass
estimates for Tier 4 crab and Tier 5 groundfish and as a method to
apportion Acceptable Biological Catches among management regions
(Sullivan et al., 2022). So then, if its primary purpose is to smooth
noisy survey biomass estimates (i.e., if we are using it as a fancy
average), do we need to care about potential red flags raised during
model validation? </p>
<ul>
<li><p><strong>Yes:</strong> In the case of the GOA Thornyhead model,
for example, it appears there is an issue with the estimation of the
additional observation error, pointing to potential
over-parameterization of the model and/or parameter redundancy. Because
terminal year predictions from the REMA model are the quantities
directly used for management, and the estimation of additional
observation error by definition increases the “smoothness” of model
predictions, the answer is likely yes in this particular case. </p></li>
<li><p><strong>Maybe not:</strong> In a hypothetical case where the
estimation of year predictions show no diagnostic concerns, but
uncertainty estimations show possible diagnostic problems, model
validation red flags might be less important. This is because
uncertainty results from REMA are not generally used for fisheries
management at the NPFMC. In other words, failed model validation
criteria are primarily a concern when they impact the quantities of
interest in the model (in our case, biomass predictions). Model
validation, and subsequent interpretation, should be considered in light
of the goal of the model, rather than as a binary pass/fail testing
procedure.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="preliminary-recommendations">Preliminary recommendations<a class="anchor" aria-label="anchor" href="#preliminary-recommendations"></a>
</h3>
<p>The model validation methods presented here are tools for stock
assessment scientists to evaluate existing models and guide development
of future models. From this analysis, we found that the REMA model can
recover parameters across the range of complexity relevant to NPFMC Tier
4 and Tier 5 stocks. Our analysis suggests that the MCMC diagnostics and
OSA residuals to be the most useful diagnostics for the REMA model. When
models fail these diagnostics, it may indicate that the model is too
complex and simplifications should be considered. We have highlighted
several places in this document how diagnostic features can help make
choices about the most appropriate model simplifications (pool process
errors, remove additional observation errors, etc.) in light of REMA
model assumptions and trade-offs between model parameters. Our results
indicate that these diagnostics are most important to explore for
existing models using multivariate configurations with multiple process
errors, multi-survey versions using CPUE indices like the longline
survey, and models estimating additional observation error. While model
validation may not be needed for all existing REMA models, we recommend
they be used when recommending new models for management.</p>
</div>
<div class="section level3">
<h3 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<p>Aeberhard, W.H., Flemming, J.M., Nielsen, A. 2018. Review of
State-Space Models for Fisheries Science. Annual Review of Statistics
and Its Application, 5(1), 215-235. <a href="https://doi.org/10.1146/annurev-statistics-031017-100427" class="external-link uri">https://doi.org/10.1146/annurev-statistics-031017-100427</a></p>
<p>Auger-Méthé, M., Field, C., Albertsen, C.M., Derocher, A.E., Lewis,
M.A., Jonsen, I.D., Flemming, J.M. 2016. State-space models’ dirty
little secrets: even simple linear Gaussian models can have estimation
problems. Scientific reports, 6(1), 26677.</p>
<p>Auger‐Méthé, M., Newman, K., Cole, D., Empacher, F., Gryba, R., King,
A. Leos-Barajas, V., Flemming, J.M., Nielsen, A, Petris, G., Thomas, L.
2021. A guide to state–space modeling of ecological time series.
Ecological Monographs, 91(4), e01470.</p>
<p>Campbell, D., &amp; Lele, S. 2014. An ANOVA test for parameter
estimability using data cloning with application to statistical
inference for dynamic systems. Computational Statistics &amp; Data
Analysis, 70, 257-267.</p>
<p>Cole, D. J. 2019. Parameter redundancy and identifiability in hidden
Markov models. Metron, 77(2), 105-118.</p>
<p>Echave, K.B., Siwicke, K.A., Sullivan, J., Ferriss, B., and Hulson,
P.J.F. 2022. Assessment of the Thornyhead stock complex in the Gulf of
Alaska. In Stock assessment and fishery evaluation report for the
groundfish fisheries of the Gulf of Alaska. North Pacific Fishery
Management Council, 605 W. 4th. Avenue, Suite 306, Anchorage, AK 99501.
<a href="https://apps-afsc.fisheries.noaa.gov/Plan_Team/2022/GOAthorny.pdf" class="external-link uri">https://apps-afsc.fisheries.noaa.gov/Plan_Team/2022/GOAthorny.pdf</a></p>
<p>Gabry, J. and Mahr, T. 2024. bayesplot: Plotting for Bayesian Models.
R package version 1.11.1, <a href="https://mc-stan.org/bayesplot/" class="external-link uri">https://mc-stan.org/bayesplot/</a>.</p>
<p>Gabry, J., Simpson, D., Vehtari, A., Betancourt, M., Gelman, A. 2019.
Visualization in Bayesian workflow. J. R. Stat. Soc. A. (182) 389-402.
<a href="doi:10.1111/rssa.12378" class="uri">doi:10.1111/rssa.12378</a>
<a href="https://doi.org/10.1111/rssa.12378" class="external-link uri">https://doi.org/10.1111/rssa.12378</a>.</p>
<p>Kristensen, K., Nielsen, A., Berg, C.W., Skaug, H., Bell, B.M. 2016.
TMB: Automatic differentiation and Laplace approximation. J Stat Softw.
2016; 70(5):21. Epub 2016-04-04. <a href="https://doi.org/10.18637/jss.v070.i05" class="external-link uri">https://doi.org/10.18637/jss.v070.i05</a></p>
<p>Monnahan, C.C., &amp; Kristensen, K. 2018. No-U-turn sampling for
fast Bayesian inference in ADMB and TMB: Introducing the adnuts and
tmbstan R packages. PloS one, 13(5), e0197954.</p>
<p>Skaug, H.J., and Fournier, D.A. 2006. Automatic approximation of the
marginal likelihood in non-Gaussian hierarchical models. Computational
Statistics &amp; Data Analysis, 51(2), 699-709.</p>
<p>Spies, I., Barbeaux, S., Hulson, H., Ortiz, I. 2023. Assessment of
the Pacifc cod stock in the Aleutian Islands. In Stock assessment and
fishery evaluation report for the groundfish fisheries of the Bering Sea
and Aleutian Islands. North Pacific Fishery Management Council, 605 W.
4th. Avenue, Suite 306, Anchorage, AK 99501. <a href="https://apps-afsc.fisheries.noaa.gov/Plan_Team/2023/AIpcod.pdf" class="external-link uri">https://apps-afsc.fisheries.noaa.gov/Plan_Team/2023/AIpcod.pdf</a></p>
<p>Stan Development Team. 2024. RStan: the R interface to Stan. R
package version 2.32.6, <a href="https://mc-stan.org/" class="external-link uri">https://mc-stan.org/</a>.</p>
<p>Sullivan, J., Monnahan, C. Hulson, P. Ianelli, J. Thorson, J. Havron,
A. 2022. REMA: A consensus version of the random effects model for ABC
apportionment and Tier 4/5 assessments. Plan Team Report, Joint
Groundfish Plan Teams, North Pacific Fishery Management Council. 605 W
4th Ave, Suite 306 Anchorage, AK 99501. <a href="https://meetings.npfmc.org/CommentReview/DownloadFile?p=eaa760cf-8a4e-4c05-aa98-82615da1982a.pdf&amp;fileName=Tier%204_5%20Random%20Effects.pdf" class="external-link">Available
through the Oct 2022 Joint GPT e-Agenda</a>.</p>
<p>Thygesen, U.H., Albertsen, C.M., Berg, C.W., Kristensen, K., &amp;
Nielsen, A. 2017. Validation of ecological state space models using the
Laplace approximation. Environmental and Ecological Statistics, 24(2),
317-339. <a href="https://doi.org/10.1007/s10651-017-0372-4" class="external-link uri">https://doi.org/10.1007/s10651-017-0372-4</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jane Sullivan, Laurinne Balstad.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
