<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>REMA basics • rema</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="REMA basics">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rema</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/ex1_basics.html">REMA basics</a></li>
    <li><a class="dropdown-item" href="../articles/ex2_cpue.html">Fitting to an additional CPUE survey</a></li>
    <li><a class="dropdown-item" href="../articles/ex3_zeros.html">Strategies for handling zero biomass observations</a></li>
    <li><a class="dropdown-item" href="../articles/ex4_model_validation.html">REMA model validation</a></li>
    <li><a class="dropdown-item" href="../articles/rema_equations.html">REMA model equations</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/JaneSullivan-NOAA/rema/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>REMA basics</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/JaneSullivan-NOAA/rema/blob/main/vignettes/ex1_basics.Rmd" class="external-link"><code>vignettes/ex1_basics.Rmd</code></a></small>
      <div class="d-none name"><code>ex1_basics.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/JaneSullivan-NOAA/rema" class="external-link">rema</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/" class="external-link">knitr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/theme_cowplot.html" class="external-link">theme_cowplot</a></span><span class="op">(</span>font_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>                     <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/background_grid.html" class="external-link">background_grid</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>                     <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/panel_border.html" class="external-link">panel_border</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>In this series of vignettes we walk through several examples of how
to prepare and fit a suite of random effects (RE) models for biomass
estimation and apportionment using the <code>rema</code> package.</p>
<div class="section level2">
<h2 id="the-rema-workflow">The <code>rema</code> workflow:<a class="anchor" aria-label="anchor" href="#the-rema-workflow"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>Load <code>rema</code> and data. The user can read biomass or
other abundance index data from file (e.g. .csv file), or they can use
the <code>rwout.rep</code> report file from the ADMB version of the RE
model using <code><a href="../reference/read_admb_re.html">read_admb_re()</a></code>.</p></li>
<li><p>Specify model structure and assumptions using
<code><a href="../reference/prepare_rema_input.html">prepare_rema_input()</a></code>. This function allows users to quickly
transition from a single to two survey model, specify alternative
process error structures, add likelihood penalties or priors on
parameters, and evaluate alternative assumptions about zero biomass
observations.</p></li>
<li><p>Fit the specified REMA model using <code><a href="../reference/fit_rema.html">fit_rema()</a></code> and
determine whether the model has met basic convergence criteria (e.g.,
Hessian is positive definite, a maximum gradient component approximately
equal to zero).</p></li>
<li><p>Extract <code>rema</code> model output into clean, consistently
formatted data frames using <code><a href="../reference/tidy_rema.html">tidy_rema()</a></code>. The user can
visualize this model output using <code><a href="../reference/plot_rema.html">plot_rema()</a></code>, or quickly
format it into tables for a report.</p></li>
<li><p>Compare alternative REMA models and conduct model selection using
<code><a href="../reference/compare_rema_models.html">compare_rema_models()</a></code>. Output from this function includes a
table of Akaike Information Criteria (AIC) when appropriate, figures,
and tidied data frames. This function also accepts model output from the
ADMB version of the RE model for easy comparison to past
models.</p></li>
</ol>
<p>Taken together, these functions allow R users to quickly fit and
interrogate a suite of simple statistical models in TMB without needing
software-specific training or expertise.</p>
</div>
<div class="section level2">
<h2 id="example-1-univariate-random-effects-re-model-with-a-single-survey-and-stratum">Example 1: Univariate random effects (RE) model with a single survey
and stratum<a class="anchor" aria-label="anchor" href="#example-1-univariate-random-effects-re-model-with-a-single-survey-and-stratum"></a>
</h2>
<p>This example uses Aleutian Islands shortraker
(<code>aisr_rwout.rep</code>) and fits to NMFS bottom trawl survey
estimates.</p>
<ol style="list-style-type: decimal">
<li>Read in the <code>rwout.rep</code>, a custom report file generated
by the ADMB version of the random effects model.</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ?read_admb_re</span></span>
<span><span class="va">admb_re</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_admb_re.html">read_admb_re</a></span><span class="op">(</span>filename <span class="op">=</span> <span class="st">'aisr_rwout.rep'</span>,</span>
<span>                        <span class="co"># optional label for the single biomass survey stratum</span></span>
<span>                        biomass_strata_names <span class="op">=</span> <span class="st">'Aleutians Islands'</span>,</span>
<span>                        model_name <span class="op">=</span> <span class="st">'ADMB: AI shortraker'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">admb_re</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "biomass_dat"           "cpue_dat"              "model_yrs"            </span></span>
<span><span class="co">#&gt; [4] "init_log_biomass_pred" "admb_re_results"</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">admb_re</span><span class="op">$</span><span class="va">biomass_dat</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">strata</th>
<th align="right">year</th>
<th align="right">biomass</th>
<th align="right">cv</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Aleutians Islands</td>
<td align="right">1980</td>
<td align="right">6829.3</td>
<td align="right">0.5531111</td>
</tr>
<tr class="even">
<td align="left">Aleutians Islands</td>
<td align="right">1983</td>
<td align="right">26275.5</td>
<td align="right">0.2006878</td>
</tr>
<tr class="odd">
<td align="left">Aleutians Islands</td>
<td align="right">1986</td>
<td align="right">11667.2</td>
<td align="right">0.2505718</td>
</tr>
<tr class="even">
<td align="left">Aleutians Islands</td>
<td align="right">1991</td>
<td align="right">21835.4</td>
<td align="right">0.6916255</td>
</tr>
<tr class="odd">
<td align="left">Aleutians Islands</td>
<td align="right">1994</td>
<td align="right">26284.4</td>
<td align="right">0.2198947</td>
</tr>
<tr class="even">
<td align="left">Aleutians Islands</td>
<td align="right">1997</td>
<td align="right">36058.3</td>
<td align="right">0.2694324</td>
</tr>
<tr class="odd">
<td align="left">Aleutians Islands</td>
<td align="right">2000</td>
<td align="right">37151.8</td>
<td align="right">0.4460828</td>
</tr>
<tr class="even">
<td align="left">Aleutians Islands</td>
<td align="right">2002</td>
<td align="right">15342.0</td>
<td align="right">0.2009741</td>
</tr>
<tr class="odd">
<td align="left">Aleutians Islands</td>
<td align="right">2004</td>
<td align="right">32611.6</td>
<td align="right">0.3743298</td>
</tr>
<tr class="even">
<td align="left">Aleutians Islands</td>
<td align="right">2006</td>
<td align="right">11780.6</td>
<td align="right">0.2522081</td>
</tr>
<tr class="odd">
<td align="left">Aleutians Islands</td>
<td align="right">2010</td>
<td align="right">18223.7</td>
<td align="right">0.2336468</td>
</tr>
<tr class="even">
<td align="left">Aleutians Islands</td>
<td align="right">2012</td>
<td align="right">15667.7</td>
<td align="right">0.2636677</td>
</tr>
<tr class="odd">
<td align="left">Aleutians Islands</td>
<td align="right">2014</td>
<td align="right">16400.5</td>
<td align="right">0.3771796</td>
</tr>
<tr class="even">
<td align="left">Aleutians Islands</td>
<td align="right">2016</td>
<td align="right">15024.0</td>
<td align="right">0.3199997</td>
</tr>
</tbody>
</table>
<ol start="2" style="list-style-type: decimal">
<li>Prepare REMA model inputs using the <code>admb_re</code> data
object.</li>
</ol>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ?prepare_rema_input </span></span>
<span><span class="va">input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_rema_input.html">prepare_rema_input</a></span><span class="op">(</span>model_name <span class="op">=</span> <span class="st">'TMB: AI shortraker'</span>, admb_re <span class="op">=</span> <span class="va">admb_re</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">input</span><span class="op">)</span> </span>
<span><span class="co">#&gt; [1] "data"        "par"         "map"         "random"      "model_name" </span></span>
<span><span class="co">#&gt; [6] "osa"         "biomass_dat"</span></span></code></pre></div>
<p>The <code>input$data</code>, <code>input$par</code>,
<code>input$map</code>, and <code>input$random</code> are used by
<code>TMB</code> to fit the REMA model. The other objects are used by
other functions to process model results or conduct residual
analyses.</p>
<p>Data could alternatively be entered into
<code><a href="../reference/prepare_rema_input.html">prepare_rema_input()</a></code> using the <code>biomass_dat</code>
argument:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># (not run)</span></span>
<span><span class="va">input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_rema_input.html">prepare_rema_input</a></span><span class="op">(</span>model_name <span class="op">=</span> <span class="st">'tmb_rema_aisr'</span>, biomass_dat <span class="op">=</span> <span class="va">admb_re</span><span class="op">$</span><span class="va">biomass_dat</span><span class="op">)</span></span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Fit REMA model</li>
</ol>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ?fit_rema</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_rema.html">fit_rema</a></span><span class="op">(</span><span class="va">input</span><span class="op">)</span></span>
<span><span class="co">#&gt; Model runtime: 0.1 seconds </span></span>
<span><span class="co">#&gt; stats::nlminb thinks the model has converged: mod$opt$convergence == 0</span></span>
<span><span class="co">#&gt; Maximum gradient component: 1.90e-11 </span></span>
<span><span class="co">#&gt; Max gradient parameter: log_PE </span></span>
<span><span class="co">#&gt; TMB:sdreport() was performed successfully for this model</span></span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Get tidied model output and plot results</li>
</ol>
<p>Note that the 95% confidence intervals of the observations (i.e.,
<code>obs_lci</code> and <code>obs_uci</code> in
<code>output$biomass_by_strata</code> are based on the assumption of
normality in log-space; therefore, they are asymmetric on the arithmetic
scale.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ?tidy_rema</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tidy_rema.html">tidy_rema</a></span><span class="op">(</span>rema_model <span class="op">=</span> <span class="va">m</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">output</span><span class="op">$</span><span class="va">parameter_estimates</span><span class="op">)</span> <span class="co"># estimated fixed effects parameters</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="26%">
<col width="19%">
<col width="13%">
<col width="13%">
<col width="13%">
<col width="13%">
</colgroup>
<thead><tr class="header">
<th align="left">model_name</th>
<th align="left">parameter</th>
<th align="right">estimate</th>
<th align="right">std_err</th>
<th align="right">lci</th>
<th align="right">uci</th>
</tr></thead>
<tbody><tr class="odd">
<td align="left">TMB: AI shortraker</td>
<td align="left">process_error</td>
<td align="right">0.1557776</td>
<td align="right">0.1044475</td>
<td align="right">0.0418584</td>
<td align="right">0.5797328</td>
</tr></tbody>
</table>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">output</span><span class="op">$</span><span class="va">biomass_by_strata</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="co"># data.frame of predicted and observed biomass by stratum</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="11%">
<col width="11%">
<col width="8%">
<col width="3%">
<col width="5%">
<col width="7%">
<col width="5%">
<col width="6%">
<col width="5%">
<col width="4%">
<col width="6%">
<col width="6%">
<col width="6%">
<col width="6%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left">model_name</th>
<th align="left">strata</th>
<th align="left">variable</th>
<th align="right">year</th>
<th align="right">log_pred</th>
<th align="right">sd_log_pred</th>
<th align="right">pred</th>
<th align="right">pred_lci</th>
<th align="right">pred_uci</th>
<th align="right">obs</th>
<th align="right">obs_cv</th>
<th align="right">log_obs</th>
<th align="right">sd_log_obs</th>
<th align="right">obs_lci</th>
<th align="right">obs_uci</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">TMB: AI shortraker</td>
<td align="left">Aleutians Islands</td>
<td align="left">biomass_pred</td>
<td align="right">1980</td>
<td align="right">9.689900</td>
<td align="right">0.3344752</td>
<td align="right">16153.63</td>
<td align="right">8386.182</td>
<td align="right">31115.44</td>
<td align="right">6829.3</td>
<td align="right">0.5531111</td>
<td align="right">8.828978</td>
<td align="right">0.51664</td>
<td align="right">2480.912</td>
<td align="right">18799.27</td>
</tr>
<tr class="even">
<td align="left">TMB: AI shortraker</td>
<td align="left">Aleutians Islands</td>
<td align="left">biomass_pred</td>
<td align="right">1981</td>
<td align="right">9.768171</td>
<td align="right">0.2704639</td>
<td align="right">17468.78</td>
<td align="right">10281.186</td>
<td align="right">29681.23</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">TMB: AI shortraker</td>
<td align="left">Aleutians Islands</td>
<td align="left">biomass_pred</td>
<td align="right">1982</td>
<td align="right">9.846441</td>
<td align="right">0.2155808</td>
<td align="right">18891.00</td>
<td align="right">12380.902</td>
<td align="right">28824.23</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">TMB: AI shortraker</td>
<td align="left">Aleutians Islands</td>
<td align="left">biomass_pred</td>
<td align="right">1983</td>
<td align="right">9.924711</td>
<td align="right">0.1784564</td>
<td align="right">20429.01</td>
<td align="right">14399.421</td>
<td align="right">28983.43</td>
<td align="right">26275.5</td>
<td align="right">0.2006878</td>
<td align="right">10.176392</td>
<td align="right">0.19871</td>
<td align="right">17799.538</td>
<td align="right">38787.63</td>
</tr>
<tr class="odd">
<td align="left">TMB: AI shortraker</td>
<td align="left">Aleutians Islands</td>
<td align="left">biomass_pred</td>
<td align="right">1984</td>
<td align="right">9.848307</td>
<td align="right">0.1919367</td>
<td align="right">18926.28</td>
<td align="right">12992.373</td>
<td align="right">27570.34</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ?plot_rema</span></span>
<span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_rema.html">plot_rema</a></span><span class="op">(</span>tidy_rema <span class="op">=</span> <span class="va">output</span>, biomass_ylab <span class="op">=</span> <span class="st">'Biomass (t)'</span><span class="op">)</span> <span class="co"># optional y-axis label</span></span>
<span><span class="va">plots</span><span class="op">$</span><span class="va">biomass_by_strata</span></span></code></pre></div>
<p><img src="ex1_basics_files/figure-html/plot-rema-1.png" width="672"></p>
<ol start="5" style="list-style-type: decimal">
<li>Compare with ADMB RE model results</li>
</ol>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ?compare_rema_models</span></span>
<span><span class="va">compare</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compare_rema_models.html">compare_rema_models</a></span><span class="op">(</span>rema_models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>,</span>
<span>                               admb_re <span class="op">=</span> <span class="va">admb_re</span>,</span>
<span>                               biomass_ylab <span class="op">=</span> <span class="st">'Biomass (t)'</span><span class="op">)</span></span>
<span><span class="va">compare</span><span class="op">$</span><span class="va">plots</span><span class="op">$</span><span class="va">biomass_by_strata</span></span></code></pre></div>
<p><img src="ex1_basics_files/figure-html/compare-1.png" width="816"></p>
</div>
<div class="section level2">
<h2 id="example-2-multivariate-random-effects-model-rem-with-a-single-survey-and-multiple-strata">Example 2: Multivariate random effects model (REM) with a single
survey and multiple strata<a class="anchor" aria-label="anchor" href="#example-2-multivariate-random-effects-model-rem-with-a-single-survey-and-multiple-strata"></a>
</h2>
<p>This example uses Bering Sea and Aleutian Islands shortspine
thornyhead (<code>bsaisst_rwout.rep</code>) and fits to the NMFS EBS
slope and AI bottom trawl survey estimates. The original ADMB model has
a single, shared process error (PE) over the three strata. This example
demonstrates how to define alternative PE structures, and how to u to
perform model selection using AIC.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">admb_re</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_admb_re.html">read_admb_re</a></span><span class="op">(</span>filename <span class="op">=</span> <span class="st">'bsaisst_rwout.rep'</span>,</span>
<span>                      biomass_strata_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'AI survey'</span>, <span class="st">'EBS slope survey'</span>, <span class="st">'S. Bering Sea (AI survey)'</span><span class="op">)</span>,</span>
<span>                      model_name <span class="op">=</span> <span class="st">'ADMB: single PE'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># the original ADMB model shared PE across all strata</span></span>
<span><span class="va">input1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_rema_input.html">prepare_rema_input</a></span><span class="op">(</span>model_name <span class="op">=</span> <span class="st">'TMB: single PE'</span>,</span>
<span>                            admb_re <span class="op">=</span> <span class="va">admb_re</span>,</span>
<span>                            PE_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pointer_PE_biomass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_rema.html">fit_rema</a></span><span class="op">(</span><span class="va">input1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Model runtime: 0.1 seconds </span></span>
<span><span class="co">#&gt; stats::nlminb thinks the model has converged: mod$opt$convergence == 0</span></span>
<span><span class="co">#&gt; Maximum gradient component: 9.81e-10 </span></span>
<span><span class="co">#&gt; Max gradient parameter: log_PE </span></span>
<span><span class="co">#&gt; TMB:sdreport() was performed successfully for this model</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tidy_rema.html">tidy_rema</a></span><span class="op">(</span>rema_model <span class="op">=</span> <span class="va">m1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">output</span><span class="op">$</span><span class="va">parameter_estimates</span><span class="op">)</span> <span class="co"># estimated fixed effects parameters</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="22%">
<col width="20%">
<col width="13%">
<col width="14%">
<col width="14%">
<col width="14%">
</colgroup>
<thead><tr class="header">
<th align="left">model_name</th>
<th align="left">parameter</th>
<th align="right">estimate</th>
<th align="right">std_err</th>
<th align="right">lci</th>
<th align="right">uci</th>
</tr></thead>
<tbody><tr class="odd">
<td align="left">TMB: single PE</td>
<td align="left">process_error</td>
<td align="right">0.121168</td>
<td align="right">0.0286548</td>
<td align="right">0.0762236</td>
<td align="right">0.1926136</td>
</tr></tbody>
</table>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">output</span><span class="op">$</span><span class="va">biomass_by_strata</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="co"># data.frame of predicted and observed biomass by stratum</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="10%">
<col width="7%">
<col width="9%">
<col width="3%">
<col width="6%">
<col width="8%">
<col width="6%">
<col width="6%">
<col width="6%">
<col width="2%">
<col width="6%">
<col width="5%">
<col width="7%">
<col width="5%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left">model_name</th>
<th align="left">strata</th>
<th align="left">variable</th>
<th align="right">year</th>
<th align="right">log_pred</th>
<th align="right">sd_log_pred</th>
<th align="right">pred</th>
<th align="right">pred_lci</th>
<th align="right">pred_uci</th>
<th align="right">obs</th>
<th align="right">obs_cv</th>
<th align="right">log_obs</th>
<th align="right">sd_log_obs</th>
<th align="right">obs_lci</th>
<th align="right">obs_uci</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">TMB: single PE</td>
<td align="left">AI survey</td>
<td align="left">biomass_pred</td>
<td align="right">1982</td>
<td align="right">8.792938</td>
<td align="right">0.4034013</td>
<td align="right">6587.561</td>
<td align="right">2987.781</td>
<td align="right">14524.48</td>
<td align="right">NA</td>
<td align="right">9.000024</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">TMB: single PE</td>
<td align="left">AI survey</td>
<td align="left">biomass_pred</td>
<td align="right">1983</td>
<td align="right">8.792938</td>
<td align="right">0.3847739</td>
<td align="right">6587.561</td>
<td align="right">3098.878</td>
<td align="right">14003.76</td>
<td align="right">NA</td>
<td align="right">9.000024</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">TMB: single PE</td>
<td align="left">AI survey</td>
<td align="left">biomass_pred</td>
<td align="right">1984</td>
<td align="right">8.792938</td>
<td align="right">0.3651976</td>
<td align="right">6587.561</td>
<td align="right">3220.089</td>
<td align="right">13476.63</td>
<td align="right">NA</td>
<td align="right">9.000024</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">TMB: single PE</td>
<td align="left">AI survey</td>
<td align="left">biomass_pred</td>
<td align="right">1985</td>
<td align="right">8.792938</td>
<td align="right">0.3445106</td>
<td align="right">6587.561</td>
<td align="right">3353.333</td>
<td align="right">12941.14</td>
<td align="right">NA</td>
<td align="right">9.000024</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">TMB: single PE</td>
<td align="left">AI survey</td>
<td align="left">biomass_pred</td>
<td align="right">1986</td>
<td align="right">8.792938</td>
<td align="right">0.3224994</td>
<td align="right">6587.560</td>
<td align="right">3501.165</td>
<td align="right">12394.72</td>
<td align="right">NA</td>
<td align="right">9.000024</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">output</span><span class="op">$</span><span class="va">total_predicted_biomass</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="co"># combined/total predicted biomass</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">model_name</th>
<th align="left">variable</th>
<th align="right">year</th>
<th align="right">pred</th>
<th align="right">pred_lci</th>
<th align="right">pred_uci</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">TMB: single PE</td>
<td align="left">tot_biomass_pred</td>
<td align="right">1982</td>
<td align="right">24821.5</td>
<td align="right">11212.94</td>
<td align="right">54946.07</td>
</tr>
<tr class="even">
<td align="left">TMB: single PE</td>
<td align="left">tot_biomass_pred</td>
<td align="right">1983</td>
<td align="right">24821.5</td>
<td align="right">11446.45</td>
<td align="right">53825.14</td>
</tr>
<tr class="odd">
<td align="left">TMB: single PE</td>
<td align="left">tot_biomass_pred</td>
<td align="right">1984</td>
<td align="right">24821.5</td>
<td align="right">11691.42</td>
<td align="right">52697.34</td>
</tr>
<tr class="even">
<td align="left">TMB: single PE</td>
<td align="left">tot_biomass_pred</td>
<td align="right">1985</td>
<td align="right">24821.5</td>
<td align="right">11948.96</td>
<td align="right">51561.54</td>
</tr>
<tr class="odd">
<td align="left">TMB: single PE</td>
<td align="left">tot_biomass_pred</td>
<td align="right">1986</td>
<td align="right">24821.5</td>
<td align="right">12220.35</td>
<td align="right">50416.45</td>
</tr>
</tbody>
</table>
<p>We can use <code>ggplot2</code> functions to modify formatting of
plots:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_rema.html">plot_rema</a></span><span class="op">(</span>tidy_rema <span class="op">=</span> <span class="va">output</span>, biomass_ylab <span class="op">=</span> <span class="st">'Biomass (t)'</span><span class="op">)</span></span>
<span><span class="va">plots</span><span class="op">$</span><span class="va">biomass_by_strata</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">strata</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">'free_y'</span><span class="op">)</span></span></code></pre></div>
<p><img src="ex1_basics_files/figure-html/plot-rema2-1.png" width="816"></p>
<p>One of the primary uses for the RE model is apportioning catch by
management area. The <code><a href="../reference/tidy_rema.html">tidy_rema()</a></code> function output includes a
table with proportions of predicted biomass by strata:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">output</span><span class="op">$</span><span class="va">proportion_biomass_by_strata</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="20%">
<col width="6%">
<col width="13%">
<col width="23%">
<col width="35%">
</colgroup>
<thead><tr class="header">
<th align="left">model_name</th>
<th align="right">year</th>
<th align="right">AI survey</th>
<th align="right">EBS slope survey</th>
<th align="right">S. Bering Sea (AI survey)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">TMB: single PE</td>
<td align="right">2018</td>
<td align="right">0.2882088</td>
<td align="right">0.6856694</td>
<td align="right">0.0261218</td>
</tr>
<tr class="even">
<td align="left">TMB: single PE</td>
<td align="right">2019</td>
<td align="right">0.2882088</td>
<td align="right">0.6856694</td>
<td align="right">0.0261218</td>
</tr>
<tr class="odd">
<td align="left">TMB: single PE</td>
<td align="right">2020</td>
<td align="right">0.2882088</td>
<td align="right">0.6856694</td>
<td align="right">0.0261218</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># figure:</span></span>
<span><span class="co"># plots$proportion_biomass_by_strata</span></span></code></pre></div>
<p>We can compare the TMB model results with the original ADMB model.
Note different confidence intervals in the ADMB and TMB versions. The
ADMB code uses the Marlow method to sum the variances of biomass in
log-space, whereas the TMB version applies the standard Delta
method.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">compare</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compare_rema_models.html">compare_rema_models</a></span><span class="op">(</span>rema_models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span>,</span>
<span>                               admb_re <span class="op">=</span> <span class="va">admb_re</span>,</span>
<span>                               biomass_ylab <span class="op">=</span> <span class="st">'Biomass (t)'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Note different confidence intervals between the ADMB version (Marlow method) and the TMB version (Delta method)</span></span>
<span><span class="va">compare</span><span class="op">$</span><span class="va">plots</span><span class="op">$</span><span class="va">biomass_by_strata</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">strata</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">'free_y'</span><span class="op">)</span></span></code></pre></div>
<p><img src="ex1_basics_files/figure-html/compare2-1.png" width="816"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">compare</span><span class="op">$</span><span class="va">plots</span><span class="op">$</span><span class="va">total_predicted_biomass</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">'BSAI Shortspine thornyhead'</span><span class="op">)</span> </span></code></pre></div>
<p><img src="ex1_basics_files/figure-html/compare3-1.png" width="816"></p>
<p>We can easily fit an alternative REMA model with strata-specific PE
parameters, and compare the two models using AIC. In this case we see
the single PE model has the lowest AIC value. Note that ADMB models
cannot currently be compared with REMA models using AIC, therefore we
omit the <code>admb_re = admb_re</code> argument in the
<code><a href="../reference/compare_rema_models.html">compare_rema_models()</a></code> function call below:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># REMA defaults to strata-specific parameters, which could be explicitly defined</span></span>
<span><span class="co"># as: PE_options = list(pointer_PE_biomass = c(1, 2, 3))</span></span>
<span><span class="va">input2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_rema_input.html">prepare_rema_input</a></span><span class="op">(</span>model_name <span class="op">=</span> <span class="st">'TMB: strata-specific PE'</span>,</span>
<span>                            admb_re <span class="op">=</span> <span class="va">admb_re</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_rema.html">fit_rema</a></span><span class="op">(</span><span class="va">input2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Model runtime: 0.3 seconds </span></span>
<span><span class="co">#&gt; stats::nlminb thinks the model has converged: mod$opt$convergence == 0</span></span>
<span><span class="co">#&gt; Maximum gradient component: 2.31e-07 </span></span>
<span><span class="co">#&gt; Max gradient parameter: log_PE </span></span>
<span><span class="co">#&gt; TMB:sdreport() was performed successfully for this model</span></span>
<span></span>
<span><span class="va">compare</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compare_rema_models.html">compare_rema_models</a></span><span class="op">(</span>rema_models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span><span class="op">)</span>,</span>
<span>                               biomass_ylab <span class="op">=</span> <span class="st">'Biomass (t)'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">compare</span><span class="op">$</span><span class="va">plots</span><span class="op">$</span><span class="va">biomass_by_strata</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">strata</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">'free_y'</span><span class="op">)</span></span></code></pre></div>
<p><img src="ex1_basics_files/figure-html/compare5-1.png" width="816"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">compare</span><span class="op">$</span><span class="va">aic</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="33%">
<col width="26%">
<col width="18%">
<col width="7%">
<col width="14%">
</colgroup>
<thead><tr class="header">
<th align="left">model_name</th>
<th align="right">objective_function</th>
<th align="right">n_parameters</th>
<th align="right">aic</th>
<th align="right">delta_aic</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">TMB: single PE</td>
<td align="right">34.73785</td>
<td align="right">1</td>
<td align="right">71.5</td>
<td align="right">0.0</td>
</tr>
<tr class="even">
<td align="left">TMB: strata-specific PE</td>
<td align="right">34.65104</td>
<td align="right">3</td>
<td align="right">75.3</td>
<td align="right">3.8</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">compare</span><span class="op">$</span><span class="va">output</span><span class="op">$</span><span class="va">parameter_estimates</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="30%">
<col width="17%">
<col width="12%">
<col width="12%">
<col width="12%">
<col width="12%">
</colgroup>
<thead><tr class="header">
<th align="left">model_name</th>
<th align="left">parameter</th>
<th align="right">estimate</th>
<th align="right">std_err</th>
<th align="right">lci</th>
<th align="right">uci</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">TMB: single PE</td>
<td align="left">process_error</td>
<td align="right">0.1211680</td>
<td align="right">0.0286548</td>
<td align="right">0.0762236</td>
<td align="right">0.1926136</td>
</tr>
<tr class="even">
<td align="left">TMB: strata-specific PE</td>
<td align="left">process_error</td>
<td align="right">0.1257423</td>
<td align="right">0.0384807</td>
<td align="right">0.0690223</td>
<td align="right">0.2290726</td>
</tr>
<tr class="odd">
<td align="left">TMB: strata-specific PE</td>
<td align="left">process_error</td>
<td align="right">0.1084952</td>
<td align="right">0.0419428</td>
<td align="right">0.0508566</td>
<td align="right">0.2314587</td>
</tr>
<tr class="even">
<td align="left">TMB: strata-specific PE</td>
<td align="left">process_error</td>
<td align="right">0.1552381</td>
<td align="right">0.1289141</td>
<td align="right">0.0304885</td>
<td align="right">0.7904241</td>
</tr>
</tbody>
</table>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jane Sullivan, Laurinne Balstad.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
